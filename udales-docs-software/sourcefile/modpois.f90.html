<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
   
    <meta name="description" content="Documentation for uDALES">
   
    <meta name="author" content="The uDALES Team" >
    <link rel="icon" href="../favicon.png">

    <title>modpois.f90 &ndash; uDALES</title>

    <link href="../css/bootstrap.min.css" rel="stylesheet">
    <link href="../css/pygments.css" rel="stylesheet">
    <link href="../css/font-awesome.min.css" rel="stylesheet">
    <link href="../css/local.css" rel="stylesheet">
    
    <link  href="../tipuesearch/tipuesearch.css" rel="stylesheet">
    
    

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    
    <script src="../js/jquery-2.1.3.min.js"></script>
    <script src="../js/svg-pan-zoom.min.js"></script>

  </head>

  <body>

    <!-- Fixed navbar -->
    <nav class="navbar navbar-inverse navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="../index.html">uDALES </a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
        
            <li class="dropdown hidden-xs visible-sm visible-md hidden-lg">
              <a href="#" class="dropdown-toggle"
              data-toggle="dropdown" role="button"
              aria-haspopup="true"
     aria-expanded="false">Contents <span class="caret"></span></a>
        <ul class="dropdown-menu">
          
              
            <li><a href="../lists/files.html">Source Files</a></li>
        
        
        
            <li><a href="../lists/modules.html">Modules</a></li>
        
            
                                
            <li><a href="../lists/procedures.html">Procedures</a></li>
        
               
            <li><a href="../lists/types.html">Derived Types</a></li>
        
        
            <li><a href="../program/dalesurban.html">Program</a></li>
      
            </ul>
            </li>


<li class="visible-xs hidden-sm visible-lg"><a href="../lists/files.html">Source Files</a></li>



<li class="visible-xs hidden-sm visible-lg"><a href="../lists/modules.html">Modules</a></li>



<li class="visible-xs hidden-sm visible-lg"><a href="../lists/procedures.html">Procedures</a></li>

                             
<li class="visible-xs hidden-sm visible-lg"><a href="../lists/types.html">Derived Types</a></li>


<li class="visible-xs hidden-sm visible-lg"><a href="../program/dalesurban.html">Program</a></li>

          </ul>
        
        <form action="../search.html" class="navbar-form navbar-right" role="search">
        <div class="form-group">
          <input type="text" class="form-control" placeholder="Search" name="q" id="tipue_search_input" autocomplete="off" required>
        </div>
<!--
        <button type="submit" class="btn btn-default">Submit</button>
-->
        </form>
        
        </div><!--/.nav-collapse -->
      </div>
    </nav>

    <div class="container">
    
  
  <div class="row">
    <h1>modpois.f90
    <small>Source File</small>
    
    </h1>
    
<div class="row">
  <div class="col-lg-12">
<div class="well well-sm">
  <ul class="list-inline" style="margin-bottom:0px;display:inline">
     
     
     
     
    
    
     <li><i class="fa fa-list-ol"></i>
       <a data-toggle="tooltip"
    data-placement="bottom" data-html="true"
    title=" 4.3% of total for source files.">602 statements</a>
     </li> 
     
     
     
    <li><i class="fa fa-code"></i><a href="../src/modpois.f90"> Source File</a></li>
     
     
  </ul>
  <ol class="breadcrumb in-well text-right">
  
    
  
     <li class="active">modpois.f90</li>
  </ol>
</div>
</div>
</div>
<script>
  $(function () {
  $('[data-toggle="tooltip"]').tooltip()
  })
</script>

  </div>
  <div class="row">
    <div class="col-md-3 hidden-xs hidden-sm visible-md visible-lg">
    
<div id="sidebar">
  
<h3>Contents</h3>
 







<div class="panel panel-primary">
  <div class="panel-heading text-left"><h3 class="panel-title"><a data-toggle="collapse" href="#mods-0">Modules</a></h3></div>
  <div id="mods-0" class="panel-collapse collapse">
    <div class="list-group">
      
      <a class="list-group-item" href="../module/modpois.html">modpois</a>
      
    </div>
  </div>
</div>
















<div class="panel panel-primary">
  <div class="panel-heading text-left"><h3 class="panel-title">Source Code</h3></div>
  <div class="list-group">
    <a class="list-group-item" href="../sourcefile/modpois.f90.html#src">modpois.f90</a>
  </div>
</div>



</div>

    </div>
    <div class="col-md-9" id='text'>
      
      <br>
    
    <div class="panel panel-default">
      <div class="panel-heading">
  <h3 class="panel-title">This file depends on</h3>
      </div>
      <div class="panel-body">
  <div class="depgraph"><?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.40.1 (20161225.0304)
 -->
<!-- Title: sourcefile~~modpois.f90~~EfferentGraph Pages: 1 -->
<svg id="sourcefilemodpoisf90EfferentGraph" width="641pt" height="364pt"
 viewBox="0.00 0.00 641.00 364.06" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="sourcefile~~modpois.f90~~EfferentGraph" class="graph" transform="scale(.7393 .7393) rotate(0) translate(4 488.4194)">
<title>sourcefile~~modpois.f90~~EfferentGraph</title>
<polygon fill="#ffffff" stroke="transparent" points="-4,4 -4,-488.4194 863,-488.4194 863,4 -4,4"/>
<!-- sourcefile~modpois.f90 -->
<g id="sourcefile~~modpois.f90~~EfferentGraph_node1" class="node">
<title>sourcefile~modpois.f90</title>
<polygon fill="none" stroke="#000000" points="859,-283.2647 780,-283.2647 780,-259.2647 859,-259.2647 859,-283.2647"/>
<text text-anchor="middle" x="819.5" y="-268.8647" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#000000">modpois.f90</text>
</g>
<!-- sourcefile~modmpi.f90 -->
<g id="sourcefile~~modpois.f90~~EfferentGraph_node2" class="node">
<title>sourcefile~modmpi.f90</title>
<g id="a_sourcefile~~modpois.f90~~EfferentGraph_node2"><a xlink:href=".././sourcefile/modmpi.f90.html" xlink:title="modmpi.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="77,-194.2647 0,-194.2647 0,-170.2647 77,-170.2647 77,-194.2647"/>
<text text-anchor="middle" x="38.5" y="-179.8647" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">modmpi.f90</text>
</a>
</g>
</g>
<!-- sourcefile~modpois.f90&#45;&gt;sourcefile~modmpi.f90 -->
<g id="sourcefile~~modpois.f90~~EfferentGraph_edge1" class="edge">
<title>sourcefile~modpois.f90&#45;&gt;sourcefile~modmpi.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M558,-465.2647C504.5973,-471.6056 489.0679,-451.8116 437,-465.2647"/>
</g>
<!-- sourcefile~modfields.f90 -->
<g id="sourcefile~~modpois.f90~~EfferentGraph_node3" class="node">
<title>sourcefile~modfields.f90</title>
<g id="a_sourcefile~~modpois.f90~~EfferentGraph_node3"><a xlink:href=".././sourcefile/modfields.f90.html" xlink:title="modfields.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="342,-438.2647 257,-438.2647 257,-414.2647 342,-414.2647 342,-438.2647"/>
<text text-anchor="middle" x="299.5" y="-423.8647" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">modfields.f90</text>
</a>
</g>
</g>
<!-- sourcefile~modpois.f90&#45;&gt;sourcefile~modfields.f90 -->
<g id="sourcefile~~modpois.f90~~EfferentGraph_edge2" class="edge">
<title>sourcefile~modpois.f90&#45;&gt;sourcefile~modfields.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M812.0462,-283.4531C784.1027,-327.4301 680.8587,-474.8519 558,-465.2647"/>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M558,-465.2647C502.0258,-471.9109 493.3673,-427.3532 437,-427.2647"/>
</g>
<!-- sourcefile~modglobal.f90 -->
<g id="sourcefile~~modpois.f90~~EfferentGraph_node4" class="node">
<title>sourcefile~modglobal.f90</title>
<g id="a_sourcefile~~modpois.f90~~EfferentGraph_node4"><a xlink:href=".././sourcefile/modglobal.f90.html" xlink:title="modglobal.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="203,-194.2647 113,-194.2647 113,-170.2647 203,-170.2647 203,-194.2647"/>
<text text-anchor="middle" x="158" y="-179.8647" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">modglobal.f90</text>
</a>
</g>
</g>
<!-- sourcefile~modpois.f90&#45;&gt;sourcefile~modglobal.f90 -->
<g id="sourcefile~~modpois.f90~~EfferentGraph_edge3" class="edge">
<title>sourcefile~modpois.f90&#45;&gt;sourcefile~modglobal.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M808.3335,-258.9111C754.5559,-200.9696 515.9713,38.4582 299.5,-24.2647"/>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M299.5,-24.2647C232.0354,-44.0595 186.4924,-122.2205 167.7006,-160.6712"/>
<polygon fill="#ff0000" stroke="#ff0000" points="164.4198,-159.4217 163.3071,-169.958 170.7475,-162.4153 164.4198,-159.4217"/>
</g>
<!-- sourcefile~modboundary.f90 -->
<g id="sourcefile~~modpois.f90~~EfferentGraph_node5" class="node">
<title>sourcefile~modboundary.f90</title>
<g id="a_sourcefile~~modpois.f90~~EfferentGraph_node5"><a xlink:href=".././sourcefile/modboundary.f90.html" xlink:title="modboundary.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="744,-283.2647 638,-283.2647 638,-259.2647 744,-259.2647 744,-283.2647"/>
<text text-anchor="middle" x="691" y="-268.8647" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">modboundary.f90</text>
</a>
</g>
</g>
<!-- sourcefile~modpois.f90&#45;&gt;sourcefile~modboundary.f90 -->
<g id="sourcefile~~modpois.f90~~EfferentGraph_edge4" class="edge">
<title>sourcefile~modpois.f90&#45;&gt;sourcefile~modboundary.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M779.8972,-271.2647C771.8408,-271.2647 763.175,-271.2647 754.5267,-271.2647"/>
<polygon fill="#ff0000" stroke="#ff0000" points="754.4199,-267.7648 744.4199,-271.2647 754.4198,-274.7648 754.4199,-267.7648"/>
</g>
<!-- sourcefile~modfields.f90&#45;&gt;sourcefile~modglobal.f90 -->
<g id="sourcefile~~modpois.f90~~EfferentGraph_edge5" class="edge">
<title>sourcefile~modfields.f90&#45;&gt;sourcefile~modglobal.f90</title>
<path fill="none" stroke="#7fff00" stroke-dasharray="5,2" d="M257.3339,-414.253C250.4321,-410.6943 243.9358,-406.122 239,-400.2647 194.8207,-347.8373 230.3332,-313.1403 203,-250.2647 195.5713,-233.1761 183.8854,-215.6835 174.284,-202.72"/>
<polygon fill="#7fff00" stroke="#7fff00" points="176.8904,-200.3655 168.0478,-194.5294 171.321,-204.606 176.8904,-200.3655"/>
</g>
<!-- sourcefile~modglobal.f90&#45;&gt;sourcefile~modmpi.f90 -->
<g id="sourcefile~~modpois.f90~~EfferentGraph_edge6" class="edge">
<title>sourcefile~modglobal.f90&#45;&gt;sourcefile~modmpi.f90</title>
<path fill="none" stroke="#00ffff" stroke-dasharray="5,2" d="M112.8222,-182.2647C104.4581,-182.2647 95.6884,-182.2647 87.2244,-182.2647"/>
<polygon fill="#00ffff" stroke="#00ffff" points="87.0997,-178.7648 77.0997,-182.2647 87.0997,-185.7648 87.0997,-178.7648"/>
</g>
<!-- sourcefile~modboundary.f90&#45;&gt;sourcefile~modmpi.f90 -->
<g id="sourcefile~~modpois.f90~~EfferentGraph_edge7" class="edge">
<title>sourcefile~modboundary.f90&#45;&gt;sourcefile~modmpi.f90</title>
<path fill="none" stroke="#7f00ff" stroke-dasharray="5,2" d="M686.4836,-258.8776C675.816,-231.1527 646.5594,-163.3927 602,-123.2647 513.7926,-43.8296 475.8828,-35.987 360,-10.2647 307.5,1.3886 290.6031,4.8737 239,-10.2647 197.95,-22.3073 194.9494,-40.704 158,-62.2647"/>
<path fill="none" stroke="#7f00ff" stroke-dasharray="5,2" d="M158,-62.2647C112.4776,-86.9279 73.0392,-134.4403 52.8543,-161.6979"/>
<polygon fill="#7f00ff" stroke="#7f00ff" points="49.7978,-159.9512 46.7661,-170.1031 55.4668,-164.0576 49.7978,-159.9512"/>
</g>
<!-- sourcefile~modboundary.f90&#45;&gt;sourcefile~modfields.f90 -->
<g id="sourcefile~~modpois.f90~~EfferentGraph_edge13" class="edge">
<title>sourcefile~modboundary.f90&#45;&gt;sourcefile~modfields.f90</title>
<path fill="none" stroke="#7f00ff" stroke-dasharray="5,2" d="M681.4279,-283.4796C650.2278,-321.749 547.1196,-436.2608 437,-427.2647"/>
<path fill="none" stroke="#7f00ff" stroke-dasharray="5,2" d="M437,-427.2647C409.0948,-427.2209 378.0048,-427.0086 352.4567,-426.7908"/>
<polygon fill="#7f00ff" stroke="#7f00ff" points="352.2657,-423.2891 342.2353,-426.7009 352.2041,-430.2888 352.2657,-423.2891"/>
</g>
<!-- sourcefile~modboundary.f90&#45;&gt;sourcefile~modglobal.f90 -->
<g id="sourcefile~~modpois.f90~~EfferentGraph_edge10" class="edge">
<title>sourcefile~modboundary.f90&#45;&gt;sourcefile~modglobal.f90</title>
<path fill="none" stroke="#7f00ff" stroke-dasharray="5,2" d="M680.7014,-259.1192C648.9446,-222.9821 547.9556,-117.6959 437,-102.2647"/>
<path fill="none" stroke="#7f00ff" stroke-dasharray="5,2" d="M437,-102.2647C395.0125,-87.5238 399.8658,-58.0376 360,-38.2647 335.2747,-26.0014 326.0091,-16.5837 299.5,-24.2647"/>
</g>
<!-- sourcefile~modinlet.f90 -->
<g id="sourcefile~~modpois.f90~~EfferentGraph_node6" class="node">
<title>sourcefile~modinlet.f90</title>
<g id="a_sourcefile~~modpois.f90~~EfferentGraph_node6"><a xlink:href=".././sourcefile/modinlet.f90.html" xlink:title="modinlet.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="598,-263.2647 518,-263.2647 518,-239.2647 598,-239.2647 598,-263.2647"/>
<text text-anchor="middle" x="558" y="-248.8647" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">modinlet.f90</text>
</a>
</g>
</g>
<!-- sourcefile~modboundary.f90&#45;&gt;sourcefile~modinlet.f90 -->
<g id="sourcefile~~modpois.f90~~EfferentGraph_edge8" class="edge">
<title>sourcefile~modboundary.f90&#45;&gt;sourcefile~modinlet.f90</title>
<path fill="none" stroke="#7f00ff" stroke-dasharray="5,2" d="M637.6702,-263.2452C628.011,-261.7927 617.9656,-260.2821 608.394,-258.8428"/>
<polygon fill="#7f00ff" stroke="#7f00ff" points="608.6436,-255.341 598.2343,-257.315 607.6026,-262.2632 608.6436,-255.341"/>
</g>
<!-- sourcefile~modinletdata.f90 -->
<g id="sourcefile~~modpois.f90~~EfferentGraph_node7" class="node">
<title>sourcefile~modinletdata.f90</title>
<g id="a_sourcefile~~modpois.f90~~EfferentGraph_node7"><a xlink:href=".././sourcefile/modinletdata.f90.html" xlink:title="modinletdata.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="351.5,-358.2647 247.5,-358.2647 247.5,-334.2647 351.5,-334.2647 351.5,-358.2647"/>
<text text-anchor="middle" x="299.5" y="-343.8647" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">modinletdata.f90</text>
</a>
</g>
</g>
<!-- sourcefile~modboundary.f90&#45;&gt;sourcefile~modinletdata.f90 -->
<g id="sourcefile~~modpois.f90~~EfferentGraph_edge9" class="edge">
<title>sourcefile~modboundary.f90&#45;&gt;sourcefile~modinletdata.f90</title>
<path fill="none" stroke="#7f00ff" stroke-dasharray="5,2" d="M558,-291.2647C503.9545,-297.7792 490.2868,-299.1346 437,-310.2647"/>
</g>
<!-- sourcefile~moddriver.f90 -->
<g id="sourcefile~~modpois.f90~~EfferentGraph_node8" class="node">
<title>sourcefile~moddriver.f90</title>
<g id="a_sourcefile~~modpois.f90~~EfferentGraph_node8"><a xlink:href=".././sourcefile/moddriver.f90.html" xlink:title="moddriver.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="602,-343.2647 514,-343.2647 514,-319.2647 602,-319.2647 602,-343.2647"/>
<text text-anchor="middle" x="558" y="-328.8647" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">moddriver.f90</text>
</a>
</g>
</g>
<!-- sourcefile~modboundary.f90&#45;&gt;sourcefile~moddriver.f90 -->
<g id="sourcefile~~modpois.f90~~EfferentGraph_edge11" class="edge">
<title>sourcefile~modboundary.f90&#45;&gt;sourcefile~moddriver.f90</title>
<path fill="none" stroke="#7f00ff" stroke-dasharray="5,2" d="M664.0855,-283.4066C643.9851,-292.4745 616.2983,-304.9648 594.2496,-314.9115"/>
<polygon fill="#7f00ff" stroke="#7f00ff" points="592.5506,-311.8383 584.8745,-319.1409 595.4292,-318.219 592.5506,-311.8383"/>
</g>
<!-- sourcefile~modsurfdata.f90 -->
<g id="sourcefile~~modpois.f90~~EfferentGraph_node9" class="node">
<title>sourcefile~modsurfdata.f90</title>
<g id="a_sourcefile~~modpois.f90~~EfferentGraph_node9"><a xlink:href=".././sourcefile/modsurfdata.f90.html" xlink:title="modsurfdata.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="350,-114.2647 249,-114.2647 249,-90.2647 350,-90.2647 350,-114.2647"/>
<text text-anchor="middle" x="299.5" y="-99.8647" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">modsurfdata.f90</text>
</a>
</g>
</g>
<!-- sourcefile~modboundary.f90&#45;&gt;sourcefile~modsurfdata.f90 -->
<g id="sourcefile~~modpois.f90~~EfferentGraph_edge12" class="edge">
<title>sourcefile~modboundary.f90&#45;&gt;sourcefile~modsurfdata.f90</title>
<path fill="none" stroke="#7f00ff" stroke-dasharray="5,2" d="M437,-102.2647C411.967,-98.7832 384.1215,-98.1815 360.0716,-98.6729"/>
<polygon fill="#7f00ff" stroke="#7f00ff" points="359.9176,-95.1757 350.0161,-98.9453 360.1072,-102.1732 359.9176,-95.1757"/>
</g>
<!-- sourcefile~modsubgriddata.f90 -->
<g id="sourcefile~~modpois.f90~~EfferentGraph_node10" class="node">
<title>sourcefile~modsubgriddata.f90</title>
<g id="a_sourcefile~~modpois.f90~~EfferentGraph_node10"><a xlink:href=".././sourcefile/modsubgriddata.f90.html" xlink:title="modsubgriddata.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="360,-316.2647 239,-316.2647 239,-292.2647 360,-292.2647 360,-316.2647"/>
<text text-anchor="middle" x="299.5" y="-301.8647" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">modsubgriddata.f90</text>
</a>
</g>
</g>
<!-- sourcefile~modboundary.f90&#45;&gt;sourcefile~modsubgriddata.f90 -->
<g id="sourcefile~~modpois.f90~~EfferentGraph_edge14" class="edge">
<title>sourcefile~modboundary.f90&#45;&gt;sourcefile~modsubgriddata.f90</title>
<path fill="none" stroke="#7f00ff" stroke-dasharray="5,2" d="M637.8149,-281.1199C613.5657,-285.1335 584.4284,-289.2887 558,-291.2647"/>
<path fill="none" stroke="#7f00ff" stroke-dasharray="5,2" d="M558,-291.2647C486.1662,-296.6356 467.9182,-292.1766 396,-296.2647 387.6763,-296.7379 378.956,-297.328 370.3051,-297.9719"/>
<polygon fill="#7f00ff" stroke="#7f00ff" points="369.9116,-294.4917 360.2096,-298.7488 370.4487,-301.4711 369.9116,-294.4917"/>
</g>
<!-- sourcefile~modinlet.f90&#45;&gt;sourcefile~modmpi.f90 -->
<g id="sourcefile~~modpois.f90~~EfferentGraph_edge15" class="edge">
<title>sourcefile~modinlet.f90&#45;&gt;sourcefile~modmpi.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M548.028,-239.0407C528.8872,-216.3756 484.6494,-167.7365 437,-141.2647"/>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M437,-141.2647C418.3432,-130.8999 412.8678,-129.3408 396,-116.2647 378.3634,-102.5927 380.2601,-90.619 360,-81.2647 278.131,-43.465 236.0332,-17.0743 158,-62.2647"/>
</g>
<!-- sourcefile~modinlet.f90&#45;&gt;sourcefile~modfields.f90 -->
<g id="sourcefile~~modpois.f90~~EfferentGraph_edge19" class="edge">
<title>sourcefile~modinlet.f90&#45;&gt;sourcefile~modfields.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M533.5712,-263.4671C526.867,-267.3932 519.8421,-272.0843 514,-277.2647 494.3127,-294.722 497.8139,-306.9513 478,-324.2647 471.7191,-329.753 379.4167,-381.6225 330.0817,-409.204"/>
<polygon fill="#ff0000" stroke="#ff0000" points="328.1354,-406.2821 321.1128,-414.2152 331.5498,-412.393 328.1354,-406.2821"/>
</g>
<!-- sourcefile~modinlet.f90&#45;&gt;sourcefile~modglobal.f90 -->
<g id="sourcefile~~modpois.f90~~EfferentGraph_edge17" class="edge">
<title>sourcefile~modinlet.f90&#45;&gt;sourcefile~modglobal.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M437,-141.2647C383.5778,-111.5859 360.602,-143.4105 299.5,-142.2647"/>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M299.5,-142.2647C262.0552,-141.5625 221.0585,-154.801 192.8774,-166.2331"/>
<polygon fill="#ff0000" stroke="#ff0000" points="191.3406,-163.0822 183.4708,-170.1756 194.0464,-169.5381 191.3406,-163.0822"/>
</g>
<!-- sourcefile~modinlet.f90&#45;&gt;sourcefile~modinletdata.f90 -->
<g id="sourcefile~~modpois.f90~~EfferentGraph_edge16" class="edge">
<title>sourcefile~modinlet.f90&#45;&gt;sourcefile~modinletdata.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M536.3275,-263.4446C507.3391,-279.4502 457.2466,-306.0358 437,-310.2647"/>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M437,-310.2647C408.3189,-316.2554 376.6632,-324.4336 350.9625,-331.4812"/>
<polygon fill="#ff0000" stroke="#ff0000" points="349.7678,-328.1802 341.0633,-334.2203 351.6346,-334.9267 349.7678,-328.1802"/>
</g>
<!-- sourcefile~modinlet.f90&#45;&gt;sourcefile~modsurfdata.f90 -->
<g id="sourcefile~~modpois.f90~~EfferentGraph_edge18" class="edge">
<title>sourcefile~modinlet.f90&#45;&gt;sourcefile~modsurfdata.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M437,-141.2647C413.3606,-128.1318 384.9285,-119.1125 360.0689,-113.0845"/>
<polygon fill="#ff0000" stroke="#ff0000" points="360.5503,-109.6035 350.0188,-110.7603 358.9731,-116.4235 360.5503,-109.6035"/>
</g>
<!-- sourcefile~modsave.f90 -->
<g id="sourcefile~~modpois.f90~~EfferentGraph_node11" class="node">
<title>sourcefile~modsave.f90</title>
<g id="a_sourcefile~~modpois.f90~~EfferentGraph_node11"><a xlink:href=".././sourcefile/modsave.f90.html" xlink:title="modsave.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="478,-244.2647 396,-244.2647 396,-220.2647 478,-220.2647 478,-244.2647"/>
<text text-anchor="middle" x="437" y="-229.8647" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">modsave.f90</text>
</a>
</g>
</g>
<!-- sourcefile~modinlet.f90&#45;&gt;sourcefile~modsave.f90 -->
<g id="sourcefile~~modpois.f90~~EfferentGraph_edge20" class="edge">
<title>sourcefile~modinlet.f90&#45;&gt;sourcefile~modsave.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M517.7088,-244.938C508.3204,-243.4638 498.1984,-241.8744 488.4022,-240.3361"/>
<polygon fill="#ff0000" stroke="#ff0000" points="488.7777,-236.8523 478.3558,-238.7586 487.6917,-243.7676 488.7777,-236.8523"/>
</g>
<!-- sourcefile~moddriver.f90&#45;&gt;sourcefile~modmpi.f90 -->
<g id="sourcefile~~modpois.f90~~EfferentGraph_edge21" class="edge">
<title>sourcefile~moddriver.f90&#45;&gt;sourcefile~modmpi.f90</title>
<path fill="none" stroke="#00ff66" stroke-dasharray="5,2" d="M552.7069,-343.5972C538.9635,-373.5835 498.8518,-449.0435 437,-465.2647"/>
<path fill="none" stroke="#00ff66" stroke-dasharray="5,2" d="M437,-465.2647C351.5276,-487.6807 310.7944,-498.7775 239,-447.2647 166.7331,-395.413 238.242,-302.6358 158,-264.2647"/>
</g>
<!-- sourcefile~moddriver.f90&#45;&gt;sourcefile~modfields.f90 -->
<g id="sourcefile~~modpois.f90~~EfferentGraph_edge24" class="edge">
<title>sourcefile~moddriver.f90&#45;&gt;sourcefile~modfields.f90</title>
<path fill="none" stroke="#00ff66" stroke-dasharray="5,2" d="M437,-386.2647C408.4445,-394.6474 376.5293,-403.9367 350.6403,-411.4518"/>
<polygon fill="#00ff66" stroke="#00ff66" points="349.6612,-408.0915 341.0327,-414.2396 351.612,-414.8142 349.6612,-408.0915"/>
</g>
<!-- sourcefile~moddriver.f90&#45;&gt;sourcefile~modglobal.f90 -->
<g id="sourcefile~~modpois.f90~~EfferentGraph_edge23" class="edge">
<title>sourcefile~moddriver.f90&#45;&gt;sourcefile~modglobal.f90</title>
<path fill="none" stroke="#00ff66" stroke-dasharray="5,2" d="M536.4193,-343.3391C512.7571,-356.0313 473.3112,-375.6054 437,-386.2647"/>
<path fill="none" stroke="#00ff66" stroke-dasharray="5,2" d="M437,-386.2647C394.5876,-398.7152 273.2594,-395.1954 239,-367.2647 196.832,-332.8865 226.2499,-299.4526 203,-250.2647 195.0371,-233.4184 183.3664,-215.9189 173.9058,-202.8915"/>
<polygon fill="#00ff66" stroke="#00ff66" points="176.5555,-200.5892 167.7819,-194.65 170.9368,-204.7642 176.5555,-200.5892"/>
</g>
<!-- sourcefile~moddriver.f90&#45;&gt;sourcefile~modinletdata.f90 -->
<g id="sourcefile~~modpois.f90~~EfferentGraph_edge22" class="edge">
<title>sourcefile~moddriver.f90&#45;&gt;sourcefile~modinletdata.f90</title>
<path fill="none" stroke="#00ff66" stroke-dasharray="5,2" d="M526.2964,-319.1989C501.8219,-311.4683 467.158,-303.9656 437,-310.2647"/>
</g>
<!-- sourcefile~moddriver.f90&#45;&gt;sourcefile~modsave.f90 -->
<g id="sourcefile~~modpois.f90~~EfferentGraph_edge25" class="edge">
<title>sourcefile~moddriver.f90&#45;&gt;sourcefile~modsave.f90</title>
<path fill="none" stroke="#00ff66" stroke-dasharray="5,2" d="M535.4401,-319.2406C528.3599,-315.1267 520.6588,-310.2872 514,-305.2647 492.4596,-289.0176 470.3618,-267.4654 455.3956,-251.9972"/>
<polygon fill="#00ff66" stroke="#00ff66" points="457.697,-249.3392 448.2601,-244.5232 452.6339,-254.173 457.697,-249.3392"/>
</g>
<!-- sourcefile~modsave.f90&#45;&gt;sourcefile~modmpi.f90 -->
<g id="sourcefile~~modpois.f90~~EfferentGraph_edge26" class="edge">
<title>sourcefile~modsave.f90&#45;&gt;sourcefile~modmpi.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M410.105,-244.3828C358.5093,-265.7384 243.1968,-304.2123 158,-264.2647"/>
</g>
<!-- sourcefile~modsave.f90&#45;&gt;sourcefile~modfields.f90 -->
<g id="sourcefile~~modpois.f90~~EfferentGraph_edge31" class="edge">
<title>sourcefile~modsave.f90&#45;&gt;sourcefile~modfields.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M431.4494,-244.5168C420.0133,-269.0988 392.1819,-325.6399 360,-367.2647 348.6637,-381.9273 333.7832,-396.486 321.6169,-407.4729"/>
<polygon fill="#ff0000" stroke="#ff0000" points="319.2489,-404.8947 314.0783,-414.1422 323.8872,-410.1375 319.2489,-404.8947"/>
</g>
<!-- sourcefile~modsave.f90&#45;&gt;sourcefile~modglobal.f90 -->
<g id="sourcefile~~modpois.f90~~EfferentGraph_edge29" class="edge">
<title>sourcefile~modsave.f90&#45;&gt;sourcefile~modglobal.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M427.0241,-220.2255C413.4113,-204.5288 387.5424,-177.2027 360,-161.2647 335.6061,-147.1487 327.6787,-142.7931 299.5,-142.2647"/>
</g>
<!-- sourcefile~modsave.f90&#45;&gt;sourcefile~modinletdata.f90 -->
<g id="sourcefile~~modpois.f90~~EfferentGraph_edge28" class="edge">
<title>sourcefile~modsave.f90&#45;&gt;sourcefile~modinletdata.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M430.0618,-244.3364C418.1649,-264.0143 392.0313,-303.036 360,-325.2647 357.6451,-326.899 355.1509,-328.417 352.5694,-329.8257"/>
<polygon fill="#ff0000" stroke="#ff0000" points="351.005,-326.6944 343.5312,-334.2039 354.0567,-332.9942 351.005,-326.6944"/>
</g>
<!-- sourcefile~modsave.f90&#45;&gt;sourcefile~modsurfdata.f90 -->
<g id="sourcefile~~modpois.f90~~EfferentGraph_edge30" class="edge">
<title>sourcefile~modsave.f90&#45;&gt;sourcefile~modsurfdata.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M430.7787,-220.0386C419.3946,-198.7469 393.2896,-154.6214 360,-128.2647 355.5744,-124.7608 350.6055,-121.6414 345.4673,-118.8884"/>
<polygon fill="#ff0000" stroke="#ff0000" points="346.6387,-115.5655 336.1167,-114.3249 343.5685,-121.8563 346.6387,-115.5655"/>
</g>
<!-- sourcefile~modsave.f90&#45;&gt;sourcefile~modsubgriddata.f90 -->
<g id="sourcefile~~modpois.f90~~EfferentGraph_edge33" class="edge">
<title>sourcefile~modsave.f90&#45;&gt;sourcefile~modsubgriddata.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M418.4087,-244.321C403.0531,-254.0456 380.5244,-267.7822 360,-278.2647 353.3503,-281.6609 346.1558,-285.0165 339.1271,-288.1312"/>
<polygon fill="#ff0000" stroke="#ff0000" points="337.4966,-285.0232 329.7123,-292.2103 340.2795,-291.4463 337.4966,-285.0232"/>
</g>
<!-- sourcefile~modibmdata.f90 -->
<g id="sourcefile~~modpois.f90~~EfferentGraph_node12" class="node">
<title>sourcefile~modibmdata.f90</title>
<g id="a_sourcefile~~modpois.f90~~EfferentGraph_node12"><a xlink:href=".././sourcefile/modibmdata.f90.html" xlink:title="modibmdata.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="350,-236.2647 249,-236.2647 249,-212.2647 350,-212.2647 350,-236.2647"/>
<text text-anchor="middle" x="299.5" y="-221.8647" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">modibmdata.f90</text>
</a>
</g>
</g>
<!-- sourcefile~modsave.f90&#45;&gt;sourcefile~modibmdata.f90 -->
<g id="sourcefile~~modpois.f90~~EfferentGraph_edge27" class="edge">
<title>sourcefile~modsave.f90&#45;&gt;sourcefile~modibmdata.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M395.7455,-229.8645C384.7326,-229.2237 372.5928,-228.5174 360.7532,-227.8285"/>
<polygon fill="#ff0000" stroke="#ff0000" points="360.6482,-224.3166 350.4618,-227.2298 360.2416,-231.3048 360.6482,-224.3166"/>
</g>
<!-- sourcefile~initfac.f90 -->
<g id="sourcefile~~modpois.f90~~EfferentGraph_node13" class="node">
<title>sourcefile~initfac.f90</title>
<g id="a_sourcefile~~modpois.f90~~EfferentGraph_node13"><a xlink:href=".././sourcefile/initfac.f90.html" xlink:title="initfac.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="332.5,-194.2647 266.5,-194.2647 266.5,-170.2647 332.5,-170.2647 332.5,-194.2647"/>
<text text-anchor="middle" x="299.5" y="-179.8647" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">initfac.f90</text>
</a>
</g>
</g>
<!-- sourcefile~modsave.f90&#45;&gt;sourcefile~initfac.f90 -->
<g id="sourcefile~~modpois.f90~~EfferentGraph_edge32" class="edge">
<title>sourcefile~modsave.f90&#45;&gt;sourcefile~initfac.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M405.5994,-220.2268C391.6634,-214.9389 375.0445,-208.7078 360,-203.2647 354.3069,-201.205 348.2985,-199.0714 342.3664,-196.9885"/>
<polygon fill="#ff0000" stroke="#ff0000" points="343.1192,-193.5442 332.5244,-193.553 340.8123,-200.1532 343.1192,-193.5442"/>
</g>
<!-- sourcefile~initfac.f90&#45;&gt;sourcefile~modmpi.f90 -->
<g id="sourcefile~~modpois.f90~~EfferentGraph_edge34" class="edge">
<title>sourcefile~initfac.f90&#45;&gt;sourcefile~modmpi.f90</title>
<path fill="none" stroke="#00ffff" stroke-dasharray="5,2" d="M266.3726,-191.6878C257.2571,-194.8313 247.5357,-198.7143 239,-203.2647 199.2316,-224.4657 198.804,-283.3971 158,-264.2647"/>
<path fill="none" stroke="#00ffff" stroke-dasharray="5,2" d="M158,-264.2647C121.2759,-247.0453 83.4178,-218.9972 60.4157,-200.586"/>
<polygon fill="#00ffff" stroke="#00ffff" points="62.613,-197.8616 52.643,-194.2768 58.2014,-203.2965 62.613,-197.8616"/>
</g>
<!-- sourcefile~initfac.f90&#45;&gt;sourcefile~modglobal.f90 -->
<g id="sourcefile~~modpois.f90~~EfferentGraph_edge35" class="edge">
<title>sourcefile~initfac.f90&#45;&gt;sourcefile~modglobal.f90</title>
<path fill="none" stroke="#00ffff" stroke-dasharray="5,2" d="M266.3245,-182.2647C250.4772,-182.2647 231.0866,-182.2647 213.1133,-182.2647"/>
<polygon fill="#00ffff" stroke="#00ffff" points="213.0199,-178.7648 203.0199,-182.2647 213.0198,-185.7648 213.0199,-178.7648"/>
</g>
</g>
</svg>
</div><script>var pansourcefilemodpoisf90EfferentGraph = svgPanZoom('#sourcefilemodpoisf90EfferentGraph', {zoomEnabled: true,controlIconsEnabled: true, fit: true, center: true,}); </script><div><a type="button" class="graph-help" data-toggle="modal" href="#graph-help-text">Help</a></div><div class="modal fade" id="graph-help-text" tabindex="-1" role="dialog"><div class="modal-dialog modal-lg" role="document"><div class="modal-content"><div class="modal-header"><button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button><h4 class="modal-title" id="-graph-help-label">Graph Key</h4></div><div class="modal-body">
    <p>Nodes of different colours represent the following: </p>
    <?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.40.1 (20161225.0304)
 -->
<!-- Title: Graph Key Pages: 1 -->
<svg width="202pt" height="32pt"
 viewBox="0.00 0.00 201.50 32.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 28)">
<title>Graph Key</title>
<polygon fill="#ffffff" stroke="transparent" points="-4,4 -4,-28 197.5,-28 197.5,4 -4,4"/>
<!-- Source File -->
<g id="node1" class="node">
<title>Source File</title>
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="71,-24 0,-24 0,0 71,0 71,-24"/>
<text text-anchor="middle" x="35.5" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">Source File</text>
</g>
<!-- This Page&#39;s Entity -->
<g id="node2" class="node">
<title>This Page&#39;s Entity</title>
<polygon fill="none" stroke="#000000" points="193.5,-24 89.5,-24 89.5,0 193.5,0 193.5,-24"/>
<text text-anchor="middle" x="141.5" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#000000">This Page&#39;s Entity</text>
</g>
</g>
</svg>

    
    <p>Solid arrows point from a file to a file which it depends on. A file
    is dependent upon another if the latter must be compiled before the former
    can be. Where possible, edges connecting nodes are given different colours to make them easier to distinguish in large graphs.
    </p>
    </div></div></div></div>
      </div>
    </div>
    
      
    <div class="panel panel-default">
      <div class="panel-heading">
  <h3 class="panel-title">Files dependent on this one</h3>
      </div>
      <div class="panel-body">
  <div class="depgraph"><?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.40.1 (20161225.0304)
 -->
<!-- Title: sourcefile~~modpois.f90~~AfferentGraph Pages: 1 -->
<svg id="sourcefilemodpoisf90AfferentGraph" width="332pt" height="52pt"
 viewBox="0.00 0.00 332.00 52.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="sourcefile~~modpois.f90~~AfferentGraph" class="graph" transform="scale(1 1) rotate(0) translate(4 48)">
<title>sourcefile~~modpois.f90~~AfferentGraph</title>
<polygon fill="#ffffff" stroke="transparent" points="-4,4 -4,-48 328,-48 328,4 -4,4"/>
<!-- sourcefile~modpois.f90 -->
<g id="sourcefile~~modpois.f90~~AfferentGraph_node1" class="node">
<title>sourcefile~modpois.f90</title>
<polygon fill="none" stroke="#000000" points="79,-44 0,-44 0,-20 79,-20 79,-44"/>
<text text-anchor="middle" x="39.5" y="-29.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#000000">modpois.f90</text>
</g>
<!-- sourcefile~program.f90 -->
<g id="sourcefile~~modpois.f90~~AfferentGraph_node2" class="node">
<title>sourcefile~program.f90</title>
<g id="a_sourcefile~~modpois.f90~~AfferentGraph_node2"><a xlink:href=".././sourcefile/program.f90.html" xlink:title="program.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="324,-44 245,-44 245,-20 324,-20 324,-44"/>
<text text-anchor="middle" x="284.5" y="-29.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">program.f90</text>
</a>
</g>
</g>
<!-- sourcefile~program.f90&#45;&gt;sourcefile~modpois.f90 -->
<g id="sourcefile~~modpois.f90~~AfferentGraph_edge1" class="edge">
<title>sourcefile~program.f90&#45;&gt;sourcefile~modpois.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M244.9252,-32.6228C233.3465,-32.7783 220.6666,-32.9227 209,-33 167.2231,-33.2767 156.7769,-33.2767 115,-33 106.7058,-32.9451 97.8994,-32.8562 89.3407,-32.7535"/>
<polygon fill="#ff0000" stroke="#ff0000" points="89.1186,-29.2505 79.0748,-32.6228 89.0294,-36.25 89.1186,-29.2505"/>
</g>
<!-- sourcefile~modstartup.f90 -->
<g id="sourcefile~~modpois.f90~~AfferentGraph_node3" class="node">
<title>sourcefile~modstartup.f90</title>
<g id="a_sourcefile~~modpois.f90~~AfferentGraph_node3"><a xlink:href=".././sourcefile/modstartup.f90.html" xlink:title="modstartup.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="209,-24 115,-24 115,0 209,0 209,-24"/>
<text text-anchor="middle" x="162" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">modstartup.f90</text>
</a>
</g>
</g>
<!-- sourcefile~program.f90&#45;&gt;sourcefile~modstartup.f90 -->
<g id="sourcefile~~modpois.f90~~AfferentGraph_edge3" class="edge">
<title>sourcefile~program.f90&#45;&gt;sourcefile~modstartup.f90</title>
<path fill="none" stroke="#00ffff" stroke-dasharray="5,2" d="M244.7278,-25.5066C236.5932,-24.1785 227.88,-22.7559 219.272,-21.3505"/>
<polygon fill="#00ffff" stroke="#00ffff" points="219.6896,-17.8724 209.2563,-19.7153 218.5616,-24.781 219.6896,-17.8724"/>
</g>
<!-- sourcefile~modstartup.f90&#45;&gt;sourcefile~modpois.f90 -->
<g id="sourcefile~~modpois.f90~~AfferentGraph_edge2" class="edge">
<title>sourcefile~modstartup.f90&#45;&gt;sourcefile~modpois.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M114.9886,-19.6753C106.4534,-21.0688 97.5277,-22.5261 88.9255,-23.9305"/>
<polygon fill="#ff0000" stroke="#ff0000" points="88.3239,-20.4823 79.0185,-25.548 89.4519,-27.3909 88.3239,-20.4823"/>
</g>
</g>
</svg>
</div><div><a type="button" class="graph-help" data-toggle="modal" href="#graph-help-text">Help</a></div><div class="modal fade" id="graph-help-text" tabindex="-1" role="dialog"><div class="modal-dialog modal-lg" role="document"><div class="modal-content"><div class="modal-header"><button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button><h4 class="modal-title" id="-graph-help-label">Graph Key</h4></div><div class="modal-body">
    <p>Nodes of different colours represent the following: </p>
    <?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.40.1 (20161225.0304)
 -->
<!-- Title: Graph Key Pages: 1 -->
<svg width="202pt" height="32pt"
 viewBox="0.00 0.00 201.50 32.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 28)">
<title>Graph Key</title>
<polygon fill="#ffffff" stroke="transparent" points="-4,4 -4,-28 197.5,-28 197.5,4 -4,4"/>
<!-- Source File -->
<g id="node1" class="node">
<title>Source File</title>
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="71,-24 0,-24 0,0 71,0 71,-24"/>
<text text-anchor="middle" x="35.5" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">Source File</text>
</g>
<!-- This Page&#39;s Entity -->
<g id="node2" class="node">
<title>This Page&#39;s Entity</title>
<polygon fill="none" stroke="#000000" points="193.5,-24 89.5,-24 89.5,0 193.5,0 193.5,-24"/>
<text text-anchor="middle" x="141.5" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#000000">This Page&#39;s Entity</text>
</g>
</g>
</svg>

    
    <p>Solid arrows point from a file to a file which it depends on. A file
    is dependent upon another if the latter must be compiled before the former
    can be. Where possible, edges connecting nodes are given different colours to make them easier to distinguish in large graphs.
    </p>
    </div></div></div></div>
      </div>
    </div>
      
      <br>

    <section class="visible-xs visible-sm hidden-md">
      
<h3>Contents</h3>
 







<div class="panel panel-primary">
  <div class="panel-heading text-left"><h3 class="panel-title"><a data-toggle="collapse" href="#mods-1">Modules</a></h3></div>
  <div id="mods-1" class="panel-collapse collapse">
    <div class="list-group">
      
      <a class="list-group-item" href="../module/modpois.html">modpois</a>
      
    </div>
  </div>
</div>
















<div class="panel panel-primary">
  <div class="panel-heading text-left"><h3 class="panel-title">Source Code</h3></div>
  <div class="list-group">
    <a class="list-group-item" href="../sourcefile/modpois.f90.html#src">modpois.f90</a>
  </div>
</div>



    </section>
    <br class="visible-xs visible-sm hidden-md">

    <section>
      <h2><span class="anchor" id="src"></span>Source Code</h2>
    <div class="hl"><pre><span></span><a name="ln-1"></a><span class="c">!&gt; \file modpois.f90</span>
<a name="ln-2"></a><span class="c">!!  Solves the Poisson equation for the pressure fluctuations</span>
<a name="ln-3"></a><span class="c">!&gt;</span>
<a name="ln-4"></a><span class="c">!!  \author Jasper Tomas, TU Delft, 31 March 2014</span>
<a name="ln-5"></a><span class="c">!!  \author Harm Jonker, TU Delft</span>
<a name="ln-6"></a><span class="c">!!  \author Hans Cuijpers, IMAU</span>
<a name="ln-7"></a><span class="c">!!  \todo documentation</span>
<a name="ln-8"></a><span class="c">!!  \par Revision list</span>
<a name="ln-9"></a><span class="c">!! Jasper Tomas: Now a different Poisson solver is implemented that can be used for inflow/outflow boundary conditions in the i-direction.</span>
<a name="ln-10"></a><span class="c">!! Periodic BC&#39;s can also still be used.</span>
<a name="ln-11"></a><span class="c">!</span>
<a name="ln-12"></a><span class="c">!  This file is part of DALES.</span>
<a name="ln-13"></a><span class="c">!</span>
<a name="ln-14"></a><span class="c">! DALES is free software; you can redistribute it and/or modify</span>
<a name="ln-15"></a><span class="c">! it under the terms of the GNU General Public License as published by</span>
<a name="ln-16"></a><span class="c">! the Free Software Foundation; either version 3 of the License, or</span>
<a name="ln-17"></a><span class="c">! (at your option) any later version.</span>
<a name="ln-18"></a><span class="c">!</span>
<a name="ln-19"></a><span class="c">! DALES is distributed in the hope that it will be useful,</span>
<a name="ln-20"></a><span class="c">! but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<a name="ln-21"></a><span class="c">! MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<a name="ln-22"></a><span class="c">! GNU General Public License for more details.</span>
<a name="ln-23"></a><span class="c">!</span>
<a name="ln-24"></a><span class="c">! You should have received a copy of the GNU General Public License</span>
<a name="ln-25"></a><span class="c">! along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>
<a name="ln-26"></a><span class="c">!</span>
<a name="ln-27"></a><span class="c">!  Copyright 1993-2009 Delft University of Technology, Wageningen University, Utrecht University, KNMI</span>
<a name="ln-28"></a><span class="c">!</span>
<a name="ln-29"></a>
<a name="ln-30"></a><span class="k">module </span><span class="n">modpois</span>
<a name="ln-31"></a>
<a name="ln-32"></a><span class="k">implicit none</span>
<a name="ln-33"></a><span class="k">private</span>
<a name="ln-34"></a><span class="k">public</span> <span class="kd">::</span> <span class="n">initpois</span><span class="p">,</span><span class="n">poisson</span><span class="p">,</span><span class="n">exitpois</span><span class="p">,</span><span class="n">p</span>
<a name="ln-35"></a><span class="k">save</span>
<a name="ln-36"></a>
<a name="ln-37"></a><span class="k">  </span><span class="kt">real</span><span class="p">,</span><span class="k">allocatable</span> <span class="kd">::</span> <span class="n">p</span><span class="p">(:,:,:)</span>   <span class="c">! difference between p at previous and new step (p = P_new - P_old)</span>
<a name="ln-38"></a>
<a name="ln-39"></a><span class="k">contains</span>
<a name="ln-40"></a><span class="k">  subroutine </span><span class="n">initpois</span>
<a name="ln-41"></a>    <span class="k">use </span><span class="n">modglobal</span><span class="p">,</span> <span class="k">only</span> <span class="p">:</span> <span class="n">ib</span><span class="p">,</span><span class="n">ie</span><span class="p">,</span><span class="n">ih</span><span class="p">,</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span><span class="p">,</span><span class="n">jh</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kh</span>
<a name="ln-42"></a>    <span class="k">implicit none</span>
<a name="ln-43"></a>
<a name="ln-44"></a><span class="k">    allocate</span><span class="p">(</span><span class="n">p</span><span class="p">(</span><span class="n">ib</span><span class="o">-</span><span class="n">ih</span><span class="p">:</span><span class="n">ie</span><span class="o">+</span><span class="n">ih</span><span class="p">,</span><span class="n">jb</span><span class="o">-</span><span class="n">jh</span><span class="p">:</span><span class="n">je</span><span class="o">+</span><span class="n">jh</span><span class="p">,</span><span class="n">kb</span><span class="o">-</span><span class="n">kh</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">))</span>
<a name="ln-45"></a>
<a name="ln-46"></a>  <span class="k">end subroutine </span><span class="n">initpois</span>
<a name="ln-47"></a>
<a name="ln-48"></a>  <span class="k">subroutine </span><span class="n">poisson</span>
<a name="ln-49"></a>    <span class="k">use </span><span class="n">modglobal</span><span class="p">,</span> <span class="k">only</span> <span class="p">:</span> <span class="n">ib</span><span class="p">,</span><span class="n">ie</span><span class="p">,</span><span class="n">ih</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kh</span><span class="p">,</span><span class="n">kmax</span><span class="p">,</span><span class="n">dxh</span><span class="p">,</span><span class="n">dxf</span><span class="p">,</span><span class="n">dy</span><span class="p">,</span><span class="n">dzf</span><span class="p">,</span><span class="n">dzh</span><span class="p">,</span><span class="n">linoutflow</span><span class="p">,</span><span class="n">iinletgen</span><span class="p">,</span><span class="n">ipoiss</span><span class="p">,</span><span class="n">POISS_FFT</span><span class="p">,</span><span class="n">POISS_CYC</span>
<a name="ln-50"></a>    <span class="k">use </span><span class="n">modmpi</span><span class="p">,</span> <span class="k">only</span> <span class="p">:</span> <span class="n">myid</span><span class="p">,</span><span class="n">nprocs</span><span class="p">,</span><span class="n">barrou</span>
<a name="ln-51"></a>    <span class="k">implicit none</span>
<a name="ln-52"></a><span class="k">    </span><span class="kt">integer </span><span class="n">ibc1</span><span class="p">,</span><span class="n">ibc2</span><span class="p">,</span><span class="n">kbc1</span><span class="p">,</span><span class="n">kbc2</span><span class="p">,</span><span class="n">ksen</span>
<a name="ln-53"></a>
<a name="ln-54"></a>    <span class="k">call </span><span class="n">fillps</span>
<a name="ln-55"></a>
<a name="ln-56"></a><span class="c">!  ibc?=1: neumann</span>
<a name="ln-57"></a><span class="c">!  ibc?=2: periodic</span>
<a name="ln-58"></a><span class="c">!  ibc?=3: dirichlet</span>
<a name="ln-59"></a>
<a name="ln-60"></a>    <span class="k">select case</span> <span class="p">(</span><span class="n">ipoiss</span><span class="p">)</span>
<a name="ln-61"></a>    <span class="k">case</span> <span class="p">(</span><span class="n">POISS_FFT</span><span class="p">)</span>
<a name="ln-62"></a>      <span class="k">call </span><span class="n">solmpj</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
<a name="ln-63"></a>    <span class="k">case</span> <span class="p">(</span><span class="n">POISS_CYC</span><span class="p">)</span>
<a name="ln-64"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">linoutflow</span> <span class="p">)</span> <span class="k">then</span>
<a name="ln-65"></a><span class="k">        </span><span class="n">ibc1</span> <span class="o">=</span> <span class="mi">1</span>      <span class="c">! inlet</span>
<a name="ln-66"></a>        <span class="n">ibc2</span> <span class="o">=</span> <span class="mi">3</span>      <span class="c">! outlet</span>
<a name="ln-67"></a>      <span class="k">else</span>
<a name="ln-68"></a><span class="k">        </span><span class="n">ibc1</span> <span class="o">=</span> <span class="mi">2</span>
<a name="ln-69"></a>        <span class="n">ibc2</span> <span class="o">=</span> <span class="mi">2</span>
<a name="ln-70"></a>      <span class="n">endif</span>
<a name="ln-71"></a>      <span class="n">kbc1</span> <span class="o">=</span> <span class="mi">1</span>
<a name="ln-72"></a>      <span class="n">kbc2</span> <span class="o">=</span> <span class="mi">1</span>
<a name="ln-73"></a>      <span class="n">ksen</span> <span class="o">=</span> <span class="n">kmax</span><span class="o">/</span><span class="n">nprocs</span>
<a name="ln-74"></a>      <span class="k">call </span><span class="n">poisr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">dxf</span><span class="p">,</span><span class="n">dxh</span><span class="p">,</span><span class="n">dy</span><span class="p">,</span><span class="n">dzf</span><span class="p">,</span><span class="n">dzh</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-75"></a>                 <span class="n">ibc1</span><span class="p">,</span><span class="n">ibc2</span><span class="p">,</span><span class="n">kbc1</span><span class="p">,</span><span class="n">kbc2</span><span class="p">,</span><span class="n">ksen</span><span class="p">)</span>
<a name="ln-76"></a>    <span class="k">case </span><span class="n">default</span>
<a name="ln-77"></a>      <span class="k">write</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s2">&quot;Invalid choice for Poisson solver&quot;</span>
<a name="ln-78"></a>       <span class="k">stop </span><span class="mi">1</span>
<a name="ln-79"></a>    <span class="k">end select</span>
<a name="ln-80"></a>
<a name="ln-81"></a><span class="k">    call </span><span class="n">tderive</span>
<a name="ln-82"></a>
<a name="ln-83"></a>  <span class="k">end subroutine </span><span class="n">poisson</span>
<a name="ln-84"></a>
<a name="ln-85"></a>  <span class="k">subroutine </span><span class="n">exitpois</span>
<a name="ln-86"></a>    <span class="k">implicit none</span>
<a name="ln-87"></a><span class="k">    deallocate</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
<a name="ln-88"></a>  <span class="k">end subroutine </span><span class="n">exitpois</span>
<a name="ln-89"></a><span class="c">!</span>
<a name="ln-90"></a><span class="c">! !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!</span>
<a name="ln-91"></a>  <span class="k">subroutine </span><span class="n">fillps</span>
<a name="ln-92"></a>
<a name="ln-93"></a>  <span class="c">! Chiel van Heerwaarden,  19 June 2007</span>
<a name="ln-94"></a>  <span class="c">! Adapted fillps for RK3 time loop</span>
<a name="ln-95"></a>
<a name="ln-96"></a>
<a name="ln-97"></a>    <span class="k">use </span><span class="n">modfields</span><span class="p">,</span> <span class="k">only</span> <span class="p">:</span> <span class="n">up</span><span class="p">,</span> <span class="n">vp</span><span class="p">,</span> <span class="n">wp</span><span class="p">,</span> <span class="n">um</span><span class="p">,</span> <span class="n">vm</span><span class="p">,</span> <span class="n">wm</span><span class="p">,</span><span class="n">u0</span><span class="p">,</span><span class="n">v0</span><span class="p">,</span><span class="n">w0</span>
<a name="ln-98"></a>    <span class="k">use </span><span class="n">modglobal</span><span class="p">,</span> <span class="k">only</span> <span class="p">:</span> <span class="n">rk3step</span><span class="p">,</span> <span class="n">ib</span><span class="p">,</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">ih</span><span class="p">,</span><span class="n">jh</span><span class="p">,</span><span class="n">kh</span><span class="p">,</span> <span class="n">dxfi</span><span class="p">,</span><span class="n">dyi</span><span class="p">,</span><span class="n">dzfi</span><span class="p">,</span><span class="n">dt</span><span class="p">,&amp;</span>
<a name="ln-99"></a>                          <span class="n">linoutflow</span><span class="p">,</span><span class="n">libm</span>
<a name="ln-100"></a>    <span class="k">use </span><span class="n">modmpi</span><span class="p">,</span>    <span class="k">only</span> <span class="p">:</span> <span class="n">excjs</span>
<a name="ln-101"></a>    <span class="k">use </span><span class="n">modboundary</span><span class="p">,</span> <span class="k">only</span><span class="p">:</span> <span class="n">bcpup</span>
<a name="ln-102"></a><span class="c">!    use modibm,    only : ibmnorm</span>
<a name="ln-103"></a>
<a name="ln-104"></a>    <span class="k">implicit none</span>
<a name="ln-105"></a><span class="k">    </span><span class="kt">real</span><span class="p">,</span><span class="k">allocatable</span> <span class="kd">::</span> <span class="n">pup</span><span class="p">(:,:,:),</span> <span class="n">pvp</span><span class="p">(:,:,:),</span> <span class="n">pwp</span><span class="p">(:,:,:)</span>
<a name="ln-106"></a>    <span class="kt">integer </span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span>
<a name="ln-107"></a>    <span class="kt">real </span><span class="n">rk3coef</span><span class="p">,</span><span class="n">rk3coefi</span>
<a name="ln-108"></a>
<a name="ln-109"></a>    <span class="k">allocate</span><span class="p">(</span><span class="n">pup</span><span class="p">(</span><span class="n">ib</span><span class="o">-</span><span class="n">ih</span><span class="p">:</span><span class="n">ie</span><span class="o">+</span><span class="n">ih</span><span class="p">,</span><span class="n">jb</span><span class="o">-</span><span class="n">jh</span><span class="p">:</span><span class="n">je</span><span class="o">+</span><span class="n">jh</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">))</span>
<a name="ln-110"></a>    <span class="k">allocate</span><span class="p">(</span><span class="n">pvp</span><span class="p">(</span><span class="n">ib</span><span class="o">-</span><span class="n">ih</span><span class="p">:</span><span class="n">ie</span><span class="o">+</span><span class="n">ih</span><span class="p">,</span><span class="n">jb</span><span class="o">-</span><span class="n">jh</span><span class="p">:</span><span class="n">je</span><span class="o">+</span><span class="n">jh</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">))</span>
<a name="ln-111"></a>    <span class="k">allocate</span><span class="p">(</span><span class="n">pwp</span><span class="p">(</span><span class="n">ib</span><span class="o">-</span><span class="n">ih</span><span class="p">:</span><span class="n">ie</span><span class="o">+</span><span class="n">ih</span><span class="p">,</span><span class="n">jb</span><span class="o">-</span><span class="n">jh</span><span class="p">:</span><span class="n">je</span><span class="o">+</span><span class="n">jh</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">))</span>
<a name="ln-112"></a>
<a name="ln-113"></a>    <span class="n">rk3coef</span> <span class="o">=</span> <span class="n">dt</span> <span class="o">/</span> <span class="p">(</span><span class="mf">4.</span> <span class="o">-</span> <span class="nb">dble</span><span class="p">(</span><span class="n">rk3step</span><span class="p">))</span>
<a name="ln-114"></a>    <span class="n">rk3coefi</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">/</span> <span class="n">rk3coef</span>
<a name="ln-115"></a>
<a name="ln-116"></a>    <span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span>
<a name="ln-117"></a>      <span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span>
<a name="ln-118"></a>        <span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="n">ib</span><span class="p">,</span><span class="n">ie</span>
<a name="ln-119"></a>          <span class="n">pup</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">up</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">+</span> <span class="n">um</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">*</span> <span class="n">rk3coefi</span>         <span class="c">! see equation 5.81</span>
<a name="ln-120"></a>          <span class="n">pvp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">vp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">+</span> <span class="n">vm</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">*</span> <span class="n">rk3coefi</span>
<a name="ln-121"></a>          <span class="n">pwp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">wp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">+</span> <span class="n">wm</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">*</span> <span class="n">rk3coefi</span>
<a name="ln-122"></a>        <span class="k">end do</span>
<a name="ln-123"></a><span class="k">      end do</span>
<a name="ln-124"></a><span class="k">    end do</span>
<a name="ln-125"></a>
<a name="ln-126"></a>  <span class="c">!****************************************************************</span>
<a name="ln-127"></a>
<a name="ln-128"></a>  <span class="c">!     Fill the right hand for the poisson solver.</span>
<a name="ln-129"></a>  <span class="c">!     The values for up(i2,j,k) and vp(i,j2,k) are still</span>
<a name="ln-130"></a>  <span class="c">!     unknown and have to be set cyclic.</span>
<a name="ln-131"></a>  <span class="c">!     Also we take wp(i,j,1) and wp(i,j,k1) equal to zero.</span>
<a name="ln-132"></a>
<a name="ln-133"></a>  <span class="c">!     NOTE:</span>
<a name="ln-134"></a>
<a name="ln-135"></a>  <span class="c">!     The poisson-solver only accepts values for i from 2 to i1,</span>
<a name="ln-136"></a>  <span class="c">!     for j from 1 to jmax and for k from 1 to kmax.</span>
<a name="ln-137"></a>  <span class="c">!     The right-hand p is therefore filled in this partical way.</span>
<a name="ln-138"></a>
<a name="ln-139"></a>  <span class="c">!**************************************************************</span>
<a name="ln-140"></a>
<a name="ln-141"></a>   <span class="k">call </span><span class="n">bcpup</span><span class="p">(</span><span class="n">pup</span><span class="p">,</span><span class="n">pvp</span><span class="p">,</span><span class="n">pwp</span><span class="p">,</span><span class="n">rk3coef</span><span class="p">)</span>   <span class="c">! boundary conditions for pup,pvp,pwp</span>
<a name="ln-142"></a>
<a name="ln-143"></a>    <span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span>
<a name="ln-144"></a>      <span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span>
<a name="ln-145"></a>        <span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="n">ib</span><span class="p">,</span><span class="n">ie</span>
<a name="ln-146"></a>          <span class="n">p</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>  <span class="o">=</span>  <span class="p">(</span> <span class="n">pup</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="n">pup</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="p">)</span> <span class="o">*</span> <span class="n">dxfi</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">&amp;</span>         <span class="c">! see equation 5.72</span>
<a name="ln-147"></a>                          <span class="o">+</span><span class="p">(</span> <span class="n">pvp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="n">pvp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="p">)</span> <span class="o">*</span> <span class="n">dyi</span> <span class="p">&amp;</span>
<a name="ln-148"></a>                          <span class="o">+</span><span class="p">(</span> <span class="n">pwp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">pwp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="p">)</span> <span class="o">*</span> <span class="n">dzfi</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<a name="ln-149"></a>        <span class="k">end do</span>
<a name="ln-150"></a><span class="k">      end do</span>
<a name="ln-151"></a><span class="k">    end do</span>
<a name="ln-152"></a>
<a name="ln-153"></a><span class="k">    deallocate</span><span class="p">(</span> <span class="n">pup</span><span class="p">,</span><span class="n">pvp</span><span class="p">,</span><span class="n">pwp</span> <span class="p">)</span>
<a name="ln-154"></a>
<a name="ln-155"></a>  <span class="k">end subroutine </span><span class="n">fillps</span>
<a name="ln-156"></a>
<a name="ln-157"></a>
<a name="ln-158"></a>  <span class="k">subroutine </span><span class="n">tderive</span>
<a name="ln-159"></a>
<a name="ln-160"></a><span class="c">!-----------------------------------------------------------------|</span>
<a name="ln-161"></a><span class="c">!                                                                 |</span>
<a name="ln-162"></a><span class="c">!*** *tderive*  read input fields for initialisation              |</span>
<a name="ln-163"></a><span class="c">!                                                                 |</span>
<a name="ln-164"></a><span class="c">!      Hans Cuijpers   I.M.A.U.     06/01/1995                    |</span>
<a name="ln-165"></a><span class="c">!                                                                 |</span>
<a name="ln-166"></a><span class="c">!     purpose.                                                    |</span>
<a name="ln-167"></a><span class="c">!     --------                                                    |</span>
<a name="ln-168"></a><span class="c">!                                                                 |</span>
<a name="ln-169"></a><span class="c">!     Refill array p with pressure values. The poisson-solver     |</span>
<a name="ln-170"></a><span class="c">!     produced a pressure array p in which the i-index varied     |</span>
<a name="ln-171"></a><span class="c">!     between 2 and i1, the j- and k-index between 1 and resp.    |</span>
<a name="ln-172"></a><span class="c">!     jmax and kmax. For our further calculations we&#39;ll change    |</span>
<a name="ln-173"></a><span class="c">!     the range for the j-index to vary between 2 and j1.         |</span>
<a name="ln-174"></a><span class="c">!                                                                 |</span>
<a name="ln-175"></a><span class="c">!     Further we set cyclic boundary conditions for the pressure- |</span>
<a name="ln-176"></a><span class="c">!     fluctuations in the x-y plane.                              |</span>
<a name="ln-177"></a><span class="c">!                                                                 |</span>
<a name="ln-178"></a><span class="c">!**   interface.                                                  |</span>
<a name="ln-179"></a><span class="c">!     ----------                                                  |</span>
<a name="ln-180"></a><span class="c">!                                                                 |</span>
<a name="ln-181"></a><span class="c">!             *tderive* is called from *program*.                 |</span>
<a name="ln-182"></a><span class="c">!                                                                 |</span>
<a name="ln-183"></a><span class="c">!-----------------------------------------------------------------|</span>
<a name="ln-184"></a>
<a name="ln-185"></a>    <span class="k">use </span><span class="n">modfields</span><span class="p">,</span> <span class="k">only</span> <span class="p">:</span> <span class="n">up</span><span class="p">,</span> <span class="n">vp</span><span class="p">,</span> <span class="n">wp</span><span class="p">,</span> <span class="n">pres0</span><span class="p">,</span> <span class="n">IIc</span><span class="p">,</span> <span class="n">IIcs</span>
<a name="ln-186"></a>    <span class="k">use </span><span class="n">modglobal</span><span class="p">,</span> <span class="k">only</span> <span class="p">:</span> <span class="n">ib</span><span class="p">,</span><span class="n">ie</span><span class="p">,</span><span class="n">ih</span><span class="p">,</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span><span class="p">,</span><span class="n">jh</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kh</span><span class="p">,</span><span class="n">dxhi</span><span class="p">,</span><span class="n">dyi</span><span class="p">,</span><span class="n">dzhi</span><span class="p">,</span><span class="n">linoutflow</span><span class="p">,</span><span class="n">rslabs</span>
<a name="ln-187"></a>    <span class="k">use </span><span class="n">modmpi</span><span class="p">,</span>    <span class="k">only</span> <span class="p">:</span> <span class="n">myid</span><span class="p">,</span><span class="n">excj</span><span class="p">,</span><span class="n">slabsum</span><span class="p">,</span><span class="n">avexy_ibm</span>
<a name="ln-188"></a>    <span class="k">use </span><span class="n">modboundary</span><span class="p">,</span><span class="k">only</span> <span class="p">:</span> <span class="n">bcp</span>
<a name="ln-189"></a>    <span class="k">implicit none</span>
<a name="ln-190"></a><span class="k">    </span><span class="kt">integer </span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span>
<a name="ln-191"></a>    <span class="kt">real</span><span class="p">,</span> <span class="k">dimension</span><span class="p">(</span><span class="n">kb</span><span class="o">-</span><span class="n">kh</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">)</span> <span class="kd">::</span> <span class="n">pij</span>
<a name="ln-192"></a><span class="c">!    logical, dimension(ib:ie, jb:je, kb:ke) :: pnan</span>
<a name="ln-193"></a>    <span class="kt">real</span> <span class="kd">::</span> <span class="n">pijk</span>
<a name="ln-194"></a><span class="c">!    integer :: ipnan</span>
<a name="ln-195"></a>
<a name="ln-196"></a>  <span class="c">! Mathieu ATTTT: CHANGED!!! Loop removed!!!</span>
<a name="ln-197"></a>
<a name="ln-198"></a>  <span class="c">! **  Boundary conditions **************</span>
<a name="ln-199"></a>
<a name="ln-200"></a>    <span class="k">call </span><span class="n">bcp</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="c">! boundary conditions for p.</span>
<a name="ln-201"></a>
<a name="ln-202"></a>  <span class="c">!*****************************************************************</span>
<a name="ln-203"></a>  <span class="c">! **  Calculate time-derivative for the velocities with known ****</span>
<a name="ln-204"></a>  <span class="c">! **  pressure gradients.  ***************************************</span>
<a name="ln-205"></a>  <span class="c">!*****************************************************************</span>
<a name="ln-206"></a>
<a name="ln-207"></a><span class="c">!   if (myid == 0) then</span>
<a name="ln-208"></a><span class="c">!     write(*,*) &quot;net ts&quot;, p(ib, jb, :)</span>
<a name="ln-209"></a><span class="c">!   end if</span>
<a name="ln-210"></a>
<a name="ln-211"></a>    <span class="c">!pnan = isnan(p(ib:ie, jb:je, kb:ke))</span>
<a name="ln-212"></a>    <span class="c">!ipnan = 0</span>
<a name="ln-213"></a>    <span class="c">!do k=kb,ke</span>
<a name="ln-214"></a>    <span class="c">!do j=jb,je</span>
<a name="ln-215"></a>    <span class="c">!do i=ib,ie</span>
<a name="ln-216"></a>    <span class="c">!  if (pnan(i,j,k)) then</span>
<a name="ln-217"></a>    <span class="c">!    ipnan = ipnan + 1</span>
<a name="ln-218"></a>    <span class="c">!  end if</span>
<a name="ln-219"></a>    <span class="c">!end do</span>
<a name="ln-220"></a>    <span class="c">!end do</span>
<a name="ln-221"></a>    <span class="c">!end do</span>
<a name="ln-222"></a><span class="c">!   write(*,*) &quot;NaN&quot;, myid, ipnan</span>
<a name="ln-223"></a>
<a name="ln-224"></a><span class="c">!    write(*,*) &quot;NaN&quot;, myid, dble(isnan(p)) !sum(real(isnan(p)))</span>
<a name="ln-225"></a>
<a name="ln-226"></a>    <span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span>
<a name="ln-227"></a>    <span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span>
<a name="ln-228"></a>    <span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="n">ib</span><span class="p">,</span><span class="n">ie</span>
<a name="ln-229"></a>      <span class="n">vp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">vp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="p">(</span><span class="n">p</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="n">p</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">*</span><span class="n">dyi</span>
<a name="ln-230"></a>    <span class="k">end do</span>
<a name="ln-231"></a><span class="k">    end do</span>
<a name="ln-232"></a><span class="k">    end do</span>
<a name="ln-233"></a>
<a name="ln-234"></a><span class="k">    if</span> <span class="p">(</span><span class="n">linoutflow</span> <span class="p">)</span> <span class="k">then</span>
<a name="ln-235"></a><span class="k">      do </span><span class="n">k</span><span class="o">=</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span>
<a name="ln-236"></a>      <span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span>
<a name="ln-237"></a>      <span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="n">ib</span><span class="p">,</span><span class="n">ie</span><span class="o">+</span><span class="mi">1</span>
<a name="ln-238"></a>        <span class="n">up</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">up</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="p">(</span><span class="n">p</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="n">p</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">*</span><span class="n">dxhi</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>           <span class="c">! see equation 5.82 (u is computed from the mass conservation)</span>
<a name="ln-239"></a>      <span class="k">end do</span>
<a name="ln-240"></a><span class="k">      end do</span>
<a name="ln-241"></a><span class="k">      end do</span>
<a name="ln-242"></a><span class="k">    else</span>
<a name="ln-243"></a><span class="k">      do </span><span class="n">k</span><span class="o">=</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span>
<a name="ln-244"></a>      <span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span>
<a name="ln-245"></a>      <span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="n">ib</span><span class="p">,</span><span class="n">ie</span>
<a name="ln-246"></a>        <span class="n">up</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">up</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="p">(</span><span class="n">p</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="n">p</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">*</span><span class="n">dxhi</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>           <span class="c">! see equation 5.82 (u is computed from the mass conservation)</span>
<a name="ln-247"></a>      <span class="k">end do</span>
<a name="ln-248"></a><span class="k">      end do</span>
<a name="ln-249"></a><span class="k">      end do</span>
<a name="ln-250"></a><span class="k">    </span><span class="n">endif</span>
<a name="ln-251"></a>
<a name="ln-252"></a>    <span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="n">kb</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">ke</span>
<a name="ln-253"></a>    <span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span>
<a name="ln-254"></a>    <span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="n">ib</span><span class="p">,</span><span class="n">ie</span>
<a name="ln-255"></a>      <span class="n">wp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">wp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="p">(</span><span class="n">p</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="n">p</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">*</span><span class="n">dzhi</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<a name="ln-256"></a>    <span class="k">end do</span>
<a name="ln-257"></a><span class="k">    end do</span>
<a name="ln-258"></a><span class="k">    end do</span>
<a name="ln-259"></a>
<a name="ln-260"></a>    <span class="c">! tg3315 02/02/2019</span>
<a name="ln-261"></a>    <span class="c">! account for pressure offset that results from ill-defined problem in pressure</span>
<a name="ln-262"></a>    <span class="c">! correction method when periodic horizontal BCs are applied. Arises within cyclic</span>
<a name="ln-263"></a>    <span class="c">! reduction scheme (called by BLKTRI) and due to the numerics in PRODP in</span>
<a name="ln-264"></a>    <span class="c">! cycred.f which define the BC in the periodic case. A linear offset existed in</span>
<a name="ln-265"></a>    <span class="c">! the pressure correction term (p) and this can be controlled by subtracting</span>
<a name="ln-266"></a>    <span class="c">! the volume averaged modified pressure from this value at all time steps.</span>
<a name="ln-267"></a>    <span class="c">! Periodic: p - &lt;p&gt;_ijk</span>
<a name="ln-268"></a>    <span class="c">! Makes no change on physical effect of modified pressure in code.</span>
<a name="ln-269"></a>
<a name="ln-270"></a>    <span class="c">! tg3315 - update 24/06/19 -- there is a missing term in the application of the periodic BCs for pup, could this be part of the problem? Test with this to see if can avoid use of pijk below.</span>
<a name="ln-271"></a>    <span class="c">! refer to mvr for necessity of this</span>
<a name="ln-272"></a>
<a name="ln-273"></a>    <span class="c">! useful refs:</span>
<a name="ln-274"></a>    <span class="c">! https://opensky.ucar.edu/islandora/object/technotes%3A98/datastream/PDF/download/citation.pdf</span>
<a name="ln-275"></a>    <span class="c">! https://epubs.siam.org/doi/pdf/10.1137/0711042</span>
<a name="ln-276"></a>
<a name="ln-277"></a>    <span class="n">pij</span> <span class="o">=</span><span class="mf">0.</span><span class="p">;</span> <span class="n">pijk</span><span class="o">=</span><span class="mf">0.</span><span class="p">;</span>
<a name="ln-278"></a>
<a name="ln-279"></a>    <span class="k">if</span> <span class="p">(.</span><span class="nb">not</span><span class="p">.</span> <span class="n">linoutflow</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-280"></a><span class="k">      call </span><span class="n">slabsum</span><span class="p">(</span><span class="n">pij</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">),</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">p</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">),</span><span class="n">ib</span><span class="p">,</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">ib</span><span class="p">,</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">)</span>
<a name="ln-281"></a>      <span class="n">pij</span> <span class="o">=</span> <span class="n">pij</span><span class="o">/</span><span class="n">rslabs</span>
<a name="ln-282"></a>      <span class="n">pijk</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">pij</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">ke</span><span class="o">-</span><span class="n">kb</span><span class="p">)</span>
<a name="ln-283"></a>    <span class="k">end if</span>
<a name="ln-284"></a>
<a name="ln-285"></a><span class="k">    do </span><span class="n">k</span><span class="o">=</span><span class="n">kb</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">ke</span><span class="o">+</span><span class="mi">1</span>
<a name="ln-286"></a>    <span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="n">jb</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">je</span><span class="o">+</span><span class="mi">1</span>
<a name="ln-287"></a>    <span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="n">ib</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">ie</span><span class="o">+</span><span class="mi">1</span>
<a name="ln-288"></a>      <span class="n">pres0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">=</span><span class="n">pres0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">+</span><span class="n">p</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="n">pijk</span> <span class="c">! update of the pressure: P_new = P_old + p</span>
<a name="ln-289"></a>    <span class="n">enddo</span>
<a name="ln-290"></a>    <span class="n">enddo</span>
<a name="ln-291"></a>    <span class="n">enddo</span>
<a name="ln-292"></a>
<a name="ln-293"></a>    <span class="k">return</span>
<a name="ln-294"></a><span class="k">  end subroutine </span><span class="n">tderive</span>
<a name="ln-295"></a>
<a name="ln-296"></a><span class="c">!ils13, 13.08.18: currently unused, not callled</span>
<a name="ln-297"></a>  <span class="k">subroutine </span><span class="n">ALL_ALL_j</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">ptrans</span><span class="p">,</span><span class="n">iaction</span><span class="p">)</span>
<a name="ln-298"></a><span class="c">! purpose: do all-to-all communication</span>
<a name="ln-299"></a><span class="c">! data are only distributed over the j-direction for p</span>
<a name="ln-300"></a><span class="c">! data are only distributed over the k-direction for ptrans</span>
<a name="ln-301"></a><span class="c">! NOTE: p     (0:imax+1  etc</span>
<a name="ln-302"></a><span class="c">!       ptrans(1:imax    etc</span>
<a name="ln-303"></a>
<a name="ln-304"></a>
<a name="ln-305"></a>  <span class="k">use </span><span class="n">modglobal</span><span class="p">,</span> <span class="k">only</span> <span class="p">:</span> <span class="n">imax</span><span class="p">,</span><span class="n">isen</span><span class="p">,</span><span class="n">jmax</span><span class="p">,</span><span class="n">jsen</span><span class="p">,</span><span class="n">jtot</span><span class="p">,</span><span class="n">kmax</span>
<a name="ln-306"></a>  <span class="k">use </span><span class="n">modmpi</span><span class="p">,</span>    <span class="k">only</span> <span class="p">:</span> <span class="n">comm3d</span><span class="p">,</span><span class="n">mpierr</span><span class="p">,</span><span class="n">my_real</span><span class="p">,</span><span class="n">nprocs</span><span class="p">,</span> <span class="n">barrou</span>
<a name="ln-307"></a>
<a name="ln-308"></a>  <span class="k">implicit none</span>
<a name="ln-309"></a>
<a name="ln-310"></a>
<a name="ln-311"></a><span class="k">  </span><span class="kt">integer  </span><span class="n">iaction</span>
<a name="ln-312"></a>  <span class="kt">real     </span><span class="n">p</span><span class="p">(</span><span class="mi">0</span><span class="p">:</span><span class="n">imax</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="n">jmax</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="n">kmax</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-313"></a>  <span class="kt">real     </span><span class="n">ptrans</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">isen</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">jtot</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">kmax</span><span class="p">)</span>
<a name="ln-314"></a>
<a name="ln-315"></a>
<a name="ln-316"></a><span class="c">! help arrays for sending and receiving</span>
<a name="ln-317"></a>
<a name="ln-318"></a>  <span class="kt">real</span><span class="p">,</span><span class="k">allocatable</span><span class="p">,</span><span class="k">dimension</span><span class="p">(:)</span> <span class="kd">::</span> <span class="n">bufin</span><span class="p">,</span> <span class="n">bufout</span>
<a name="ln-319"></a>
<a name="ln-320"></a>
<a name="ln-321"></a><span class="c">! help variables</span>
<a name="ln-322"></a>
<a name="ln-323"></a>  <span class="kt">integer </span><span class="n">ii</span><span class="p">,</span> <span class="n">jbegin</span><span class="p">,</span> <span class="n">jend</span><span class="p">,</span> <span class="n">proc</span>
<a name="ln-324"></a>  <span class="kt">integer     </span><span class="n">ibegin</span><span class="p">,</span> <span class="n">iend</span>
<a name="ln-325"></a>  <span class="kt">integer     </span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span>
<a name="ln-326"></a>
<a name="ln-327"></a>  <span class="k">allocate</span><span class="p">(</span><span class="n">bufin</span><span class="p">(</span><span class="n">imax</span><span class="o">*</span><span class="n">jmax</span><span class="o">*</span><span class="n">kmax</span><span class="p">),</span><span class="n">bufout</span><span class="p">(</span><span class="n">imax</span><span class="o">*</span><span class="n">jmax</span><span class="o">*</span><span class="n">kmax</span><span class="p">))</span>
<a name="ln-328"></a>  <span class="k">if</span><span class="p">(</span><span class="n">iaction</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span><span class="k">then</span>
<a name="ln-329"></a><span class="k">    </span><span class="n">ii</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-330"></a>    <span class="k">do </span><span class="n">proc</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">nprocs</span><span class="o">-</span><span class="mi">1</span>
<a name="ln-331"></a>      <span class="n">ibegin</span> <span class="o">=</span>  <span class="p">(</span><span class="n">proc</span><span class="p">)</span><span class="o">*</span><span class="n">isen</span><span class="o">+</span><span class="mi">1</span>
<a name="ln-332"></a>      <span class="n">iend</span>   <span class="o">=</span>  <span class="p">(</span><span class="n">proc</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">isen</span>
<a name="ln-333"></a>      <span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="n">ibegin</span><span class="p">,</span><span class="n">iend</span>
<a name="ln-334"></a>      <span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">jmax</span>
<a name="ln-335"></a>      <span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">kmax</span>
<a name="ln-336"></a>        <span class="n">ii</span> <span class="o">=</span> <span class="n">ii</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-337"></a>        <span class="n">bufin</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span> <span class="o">=</span> <span class="n">p</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>
<a name="ln-338"></a>      <span class="n">enddo</span>
<a name="ln-339"></a>      <span class="n">enddo</span>
<a name="ln-340"></a>      <span class="n">enddo</span>
<a name="ln-341"></a>    <span class="n">enddo</span>
<a name="ln-342"></a>
<a name="ln-343"></a>    <span class="n">ii</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-344"></a><span class="c">!     call barrou()</span>
<a name="ln-345"></a>    <span class="k">call </span><span class="n">MPI_ALLTOALL</span><span class="p">(</span><span class="n">bufin</span><span class="p">,</span>   <span class="p">(</span><span class="n">isen</span><span class="o">*</span><span class="n">jsen</span><span class="o">*</span><span class="n">kmax</span><span class="p">),</span><span class="n">MY_REAL</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-346"></a>                          <span class="n">bufout</span><span class="p">,(</span><span class="n">isen</span><span class="o">*</span><span class="n">jsen</span><span class="o">*</span><span class="n">kmax</span><span class="p">),</span><span class="n">MY_REAL</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-347"></a>                          <span class="n">comm3d</span><span class="p">,</span><span class="n">mpierr</span><span class="p">)</span>
<a name="ln-348"></a><span class="c">!     call barrou()</span>
<a name="ln-349"></a>    <span class="n">ii</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-350"></a>    <span class="k">do </span><span class="n">proc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span><span class="n">nprocs</span><span class="o">-</span><span class="mi">1</span>
<a name="ln-351"></a>      <span class="n">jbegin</span> <span class="o">=</span>  <span class="n">proc</span>   <span class="o">*</span><span class="n">jsen</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-352"></a>      <span class="n">jend</span>   <span class="o">=</span> <span class="p">(</span><span class="n">proc</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">jsen</span>
<a name="ln-353"></a>      <span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">isen</span>
<a name="ln-354"></a>      <span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="n">jbegin</span><span class="p">,</span><span class="n">jend</span>
<a name="ln-355"></a>      <span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">kmax</span>
<a name="ln-356"></a>        <span class="n">ii</span> <span class="o">=</span> <span class="n">ii</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-357"></a>        <span class="n">ptrans</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">bufout</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span>
<a name="ln-358"></a>      <span class="n">enddo</span>
<a name="ln-359"></a>      <span class="n">enddo</span>
<a name="ln-360"></a>      <span class="n">enddo</span>
<a name="ln-361"></a>    <span class="n">enddo</span>
<a name="ln-362"></a><span class="c">!     call barrou()</span>
<a name="ln-363"></a>
<a name="ln-364"></a>  <span class="n">elseif</span><span class="p">(</span><span class="n">iaction</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span><span class="k">then</span>
<a name="ln-365"></a><span class="k">    </span><span class="n">ii</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-366"></a>    <span class="k">do  </span><span class="n">proc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span><span class="n">nprocs</span><span class="o">-</span><span class="mi">1</span>
<a name="ln-367"></a>      <span class="n">jbegin</span> <span class="o">=</span>  <span class="n">proc</span>   <span class="o">*</span><span class="n">jsen</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-368"></a>      <span class="n">jend</span>   <span class="o">=</span> <span class="p">(</span><span class="n">proc</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">jsen</span>
<a name="ln-369"></a>      <span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">isen</span>
<a name="ln-370"></a>      <span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="n">jbegin</span><span class="p">,</span><span class="n">jend</span>
<a name="ln-371"></a>      <span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">kmax</span>
<a name="ln-372"></a>        <span class="n">ii</span> <span class="o">=</span> <span class="n">ii</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-373"></a>        <span class="n">bufin</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span>  <span class="o">=</span> <span class="n">ptrans</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>
<a name="ln-374"></a>      <span class="n">enddo</span>
<a name="ln-375"></a>      <span class="n">enddo</span>
<a name="ln-376"></a>      <span class="n">enddo</span>
<a name="ln-377"></a>    <span class="n">enddo</span>
<a name="ln-378"></a>
<a name="ln-379"></a><span class="c">!     call barrou()</span>
<a name="ln-380"></a>    <span class="k">call </span><span class="n">MPI_ALLTOALL</span><span class="p">(</span><span class="n">bufin</span><span class="p">,</span>   <span class="p">(</span><span class="n">isen</span><span class="o">*</span><span class="n">jsen</span><span class="o">*</span><span class="n">kmax</span><span class="p">),</span><span class="n">MY_REAL</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-381"></a>                          <span class="n">bufout</span><span class="p">,(</span><span class="n">isen</span><span class="o">*</span><span class="n">jsen</span><span class="o">*</span><span class="n">kmax</span><span class="p">),</span><span class="n">MY_REAL</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-382"></a>                          <span class="n">comm3d</span><span class="p">,</span><span class="n">mpierr</span><span class="p">)</span>
<a name="ln-383"></a><span class="c">!     call barrou()</span>
<a name="ln-384"></a>
<a name="ln-385"></a>    <span class="n">ii</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-386"></a>    <span class="k">do </span><span class="n">proc</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">nprocs</span><span class="o">-</span><span class="mi">1</span>
<a name="ln-387"></a>      <span class="n">ibegin</span> <span class="o">=</span>    <span class="p">(</span><span class="n">proc</span><span class="p">)</span><span class="o">*</span><span class="n">isen</span><span class="o">+</span><span class="mi">1</span>
<a name="ln-388"></a>      <span class="n">iend</span>   <span class="o">=</span>  <span class="p">(</span><span class="n">proc</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">isen</span>
<a name="ln-389"></a>      <span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="n">ibegin</span><span class="p">,</span><span class="n">iend</span>
<a name="ln-390"></a>      <span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">jmax</span>
<a name="ln-391"></a>      <span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">kmax</span>
<a name="ln-392"></a>        <span class="n">ii</span> <span class="o">=</span> <span class="n">ii</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-393"></a>        <span class="n">p</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">bufout</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span>
<a name="ln-394"></a>      <span class="n">enddo</span>
<a name="ln-395"></a>      <span class="n">enddo</span>
<a name="ln-396"></a>      <span class="n">enddo</span>
<a name="ln-397"></a>    <span class="n">enddo</span>
<a name="ln-398"></a><span class="c">!     call barrou()</span>
<a name="ln-399"></a>  <span class="n">endif</span>
<a name="ln-400"></a>
<a name="ln-401"></a>  <span class="k">deallocate</span><span class="p">(</span><span class="n">bufin</span><span class="p">,</span><span class="n">bufout</span><span class="p">)</span>
<a name="ln-402"></a>
<a name="ln-403"></a>  <span class="k">return</span>
<a name="ln-404"></a><span class="k">  end subroutine </span><span class="n">ALL_ALL_j</span>
<a name="ln-405"></a><span class="c">!</span>
<a name="ln-406"></a><span class="c">! Mathieu added ALL_ALL_j2 which transposes between j and k instead of i and k</span>
<a name="ln-407"></a><span class="c">! This was to be able to use solver poisr, maybe we should tidy this up later</span>
<a name="ln-408"></a><span class="c">! on! ALL_ALL_j2 uses ksen which is NOT in the modules... it is provided in the </span>
<a name="ln-409"></a><span class="c">! header for this reason</span>
<a name="ln-410"></a><span class="c">!</span>
<a name="ln-411"></a>
<a name="ln-412"></a>      <span class="k">subroutine </span><span class="n">ALL_ALL_j2</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">ptrans</span><span class="p">,</span><span class="n">iaction</span><span class="p">,</span><span class="n">ksen</span><span class="p">)</span>
<a name="ln-413"></a><span class="c">!</span>
<a name="ln-414"></a>  <span class="k">use </span><span class="n">modglobal</span><span class="p">,</span> <span class="k">only</span> <span class="p">:</span> <span class="n">imax</span><span class="p">,</span><span class="n">isen</span><span class="p">,</span><span class="n">jmax</span><span class="p">,</span><span class="n">jsen</span><span class="p">,</span><span class="n">jtot</span><span class="p">,</span><span class="n">kmax</span>
<a name="ln-415"></a>  <span class="k">use </span><span class="n">modmpi</span><span class="p">,</span>    <span class="k">only</span> <span class="p">:</span> <span class="n">comm3d</span><span class="p">,</span><span class="n">mpierr</span><span class="p">,</span><span class="n">my_real</span><span class="p">,</span><span class="n">nprocs</span><span class="p">,</span> <span class="n">barrou</span>
<a name="ln-416"></a>
<a name="ln-417"></a>      <span class="k">implicit none</span>
<a name="ln-418"></a><span class="c">!</span>
<a name="ln-419"></a><span class="c">!     include &#39;param.txt&#39;</span>
<a name="ln-420"></a><span class="c">!</span>
<a name="ln-421"></a><span class="c">!     include &#39;mpif.h&#39;</span>
<a name="ln-422"></a><span class="c">!     include &#39;mpi_cons.txt&#39;</span>
<a name="ln-423"></a><span class="c">!</span>
<a name="ln-424"></a>      <span class="kt">integer  </span><span class="n">iaction</span><span class="p">,</span> <span class="n">ksen</span>
<a name="ln-425"></a>      <span class="kt">real     </span><span class="n">p</span><span class="p">(</span><span class="mi">0</span><span class="p">:</span><span class="n">imax</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="n">jmax</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="n">kmax</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-426"></a>      <span class="kt">real     </span><span class="n">ptrans</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">imax</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">jtot</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">ksen</span><span class="p">)</span>
<a name="ln-427"></a>      <span class="kt">integer </span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span>
<a name="ln-428"></a><span class="c">!</span>
<a name="ln-429"></a><span class="c">!</span>
<a name="ln-430"></a><span class="c">! purpose: do all-to-all communication</span>
<a name="ln-431"></a><span class="c">!</span>
<a name="ln-432"></a><span class="c">! data are only distributed over the j-direction for p</span>
<a name="ln-433"></a><span class="c">! data are only distributed over the k-direction for ptrans</span>
<a name="ln-434"></a><span class="c">!</span>
<a name="ln-435"></a><span class="c">! help arrays for sending and receiving</span>
<a name="ln-436"></a><span class="c">!</span>
<a name="ln-437"></a>       <span class="kt">real </span><span class="n">bufin</span> <span class="p">((</span><span class="n">imax</span><span class="p">)</span><span class="o">*</span><span class="n">jmax</span><span class="o">*</span><span class="p">(</span><span class="n">kmax</span><span class="p">))</span>
<a name="ln-438"></a>       <span class="kt">real </span><span class="n">bufout</span><span class="p">((</span><span class="n">imax</span><span class="p">)</span><span class="o">*</span><span class="n">jmax</span><span class="o">*</span><span class="p">(</span><span class="n">kmax</span><span class="p">))</span>
<a name="ln-439"></a><span class="c">!</span>
<a name="ln-440"></a><span class="c">! help variables</span>
<a name="ln-441"></a><span class="c">!</span>
<a name="ln-442"></a>       <span class="kt">integer </span><span class="n">ii</span><span class="p">,</span> <span class="n">jstart</span><span class="p">,</span> <span class="n">jend</span><span class="p">,</span> <span class="n">proc</span>
<a name="ln-443"></a>       <span class="kt">integer     </span><span class="n">kstart</span><span class="p">,</span> <span class="n">kend</span><span class="p">,</span> <span class="n">jvalue</span><span class="p">,</span> <span class="n">kvalue</span>
<a name="ln-444"></a><span class="c">!</span>
<a name="ln-445"></a><span class="c">!</span>
<a name="ln-446"></a>       <span class="k">if</span><span class="p">(</span><span class="n">iaction</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span><span class="k">then</span>
<a name="ln-447"></a><span class="c">!</span>
<a name="ln-448"></a>       <span class="n">ii</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-449"></a>       <span class="k">do </span><span class="n">proc</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">nprocs</span><span class="o">-</span><span class="mi">1</span>
<a name="ln-450"></a>          <span class="n">kstart</span> <span class="o">=</span>    <span class="p">(</span><span class="n">proc</span><span class="p">)</span><span class="o">*</span><span class="n">ksen</span><span class="o">+</span><span class="mi">1</span>
<a name="ln-451"></a>          <span class="n">kend</span>   <span class="o">=</span>  <span class="p">(</span><span class="n">proc</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">ksen</span>
<a name="ln-452"></a>       <span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="n">kstart</span><span class="p">,</span><span class="n">kend</span>
<a name="ln-453"></a>       <span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">jmax</span>
<a name="ln-454"></a>       <span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">imax</span>
<a name="ln-455"></a>          <span class="n">ii</span> <span class="o">=</span> <span class="n">ii</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-456"></a>          <span class="n">bufin</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span> <span class="o">=</span> <span class="n">p</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>
<a name="ln-457"></a>       <span class="n">enddo</span>
<a name="ln-458"></a>       <span class="n">enddo</span>
<a name="ln-459"></a>       <span class="n">enddo</span>
<a name="ln-460"></a>       <span class="n">enddo</span>
<a name="ln-461"></a>       
<a name="ln-462"></a><span class="c">!</span>
<a name="ln-463"></a><span class="c">!</span>
<a name="ln-464"></a>       <span class="n">ii</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-465"></a><span class="c">!</span>
<a name="ln-466"></a><span class="c">!</span>
<a name="ln-467"></a>       <span class="k">call </span><span class="n">barrou</span><span class="p">()</span>
<a name="ln-468"></a><span class="c">!</span>
<a name="ln-469"></a>       <span class="k">call </span><span class="n">MPI_ALLTOALL</span><span class="p">(</span><span class="n">bufin</span><span class="p">,</span>   <span class="p">(</span><span class="n">imax</span><span class="o">*</span><span class="n">jsen</span><span class="o">*</span><span class="n">ksen</span><span class="p">),</span><span class="n">MY_REAL</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-470"></a>                           <span class="n">bufout</span><span class="p">,(</span><span class="n">imax</span><span class="o">*</span><span class="n">jsen</span><span class="o">*</span><span class="n">ksen</span><span class="p">),</span><span class="n">MY_REAL</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-471"></a>                           <span class="n">comm3d</span><span class="p">,</span><span class="n">mpierr</span><span class="p">)</span>
<a name="ln-472"></a><span class="c">!      bufout = bufin</span>
<a name="ln-473"></a><span class="c">!</span>
<a name="ln-474"></a>       <span class="k">call </span><span class="n">barrou</span><span class="p">()</span>
<a name="ln-475"></a><span class="c">!</span>
<a name="ln-476"></a>       <span class="n">ii</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-477"></a><span class="c">!</span>
<a name="ln-478"></a>       <span class="k">do  </span><span class="n">proc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span><span class="n">nprocs</span><span class="o">-</span><span class="mi">1</span>
<a name="ln-479"></a>           <span class="n">jstart</span> <span class="o">=</span>  <span class="n">proc</span>   <span class="o">*</span><span class="n">jsen</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-480"></a>           <span class="n">jend</span>   <span class="o">=</span> <span class="p">(</span><span class="n">proc</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">jsen</span>
<a name="ln-481"></a>       <span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">ksen</span>
<a name="ln-482"></a>       <span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="n">jstart</span><span class="p">,</span><span class="n">jend</span>
<a name="ln-483"></a>       <span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">imax</span>
<a name="ln-484"></a>          <span class="n">ii</span> <span class="o">=</span> <span class="n">ii</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-485"></a>          <span class="n">ptrans</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">bufout</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span> 
<a name="ln-486"></a>       <span class="n">enddo</span>
<a name="ln-487"></a>       <span class="n">enddo</span>
<a name="ln-488"></a>       <span class="n">enddo</span>
<a name="ln-489"></a><span class="c">!</span>
<a name="ln-490"></a>       <span class="n">enddo</span>
<a name="ln-491"></a><span class="c">! </span>
<a name="ln-492"></a><span class="c">!</span>
<a name="ln-493"></a>       <span class="k">call </span><span class="n">barrou</span><span class="p">()</span>
<a name="ln-494"></a><span class="c">!</span>
<a name="ln-495"></a><span class="c">!  </span>
<a name="ln-496"></a>       <span class="n">elseif</span><span class="p">(</span><span class="n">iaction</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span><span class="k">then</span>
<a name="ln-497"></a><span class="c">!</span>
<a name="ln-498"></a>       <span class="n">ii</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-499"></a><span class="c">!</span>
<a name="ln-500"></a>       <span class="k">do  </span><span class="n">proc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span><span class="n">nprocs</span><span class="o">-</span><span class="mi">1</span>
<a name="ln-501"></a>           <span class="n">jstart</span> <span class="o">=</span>  <span class="n">proc</span>   <span class="o">*</span><span class="n">jsen</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-502"></a>           <span class="n">jend</span>   <span class="o">=</span> <span class="p">(</span><span class="n">proc</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">jsen</span>
<a name="ln-503"></a>       <span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">ksen</span>
<a name="ln-504"></a>       <span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="n">jstart</span><span class="p">,</span><span class="n">jend</span>
<a name="ln-505"></a>       <span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">imax</span>
<a name="ln-506"></a>          <span class="n">ii</span> <span class="o">=</span> <span class="n">ii</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-507"></a>          <span class="n">bufin</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span>  <span class="o">=</span> <span class="n">ptrans</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> 
<a name="ln-508"></a>       <span class="n">enddo</span>
<a name="ln-509"></a>       <span class="n">enddo</span>
<a name="ln-510"></a>       <span class="n">enddo</span>
<a name="ln-511"></a><span class="c">!</span>
<a name="ln-512"></a>       <span class="n">enddo</span>
<a name="ln-513"></a><span class="c">!</span>
<a name="ln-514"></a>       <span class="k">call </span><span class="n">barrou</span><span class="p">()</span>
<a name="ln-515"></a><span class="c">!</span>
<a name="ln-516"></a>       <span class="k">call </span><span class="n">MPI_ALLTOALL</span><span class="p">(</span><span class="n">bufin</span><span class="p">,</span>   <span class="p">(</span><span class="n">imax</span><span class="o">*</span><span class="n">jsen</span><span class="o">*</span><span class="n">ksen</span><span class="p">),</span><span class="n">MY_REAL</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-517"></a>                           <span class="n">bufout</span><span class="p">,(</span><span class="n">imax</span><span class="o">*</span><span class="n">jsen</span><span class="o">*</span><span class="n">ksen</span><span class="p">),</span><span class="n">MY_REAL</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-518"></a>                           <span class="n">comm3d</span><span class="p">,</span><span class="n">mpierr</span><span class="p">)</span>
<a name="ln-519"></a><span class="c">!      bufout = bufin</span>
<a name="ln-520"></a><span class="c">!</span>
<a name="ln-521"></a>       <span class="k">call </span><span class="n">barrou</span><span class="p">()</span>
<a name="ln-522"></a><span class="c">! </span>
<a name="ln-523"></a><span class="c">!</span>
<a name="ln-524"></a>       <span class="n">ii</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-525"></a><span class="c">!</span>
<a name="ln-526"></a>       <span class="k">do </span><span class="n">proc</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">nprocs</span><span class="o">-</span><span class="mi">1</span>
<a name="ln-527"></a>          <span class="n">kstart</span> <span class="o">=</span>    <span class="p">(</span><span class="n">proc</span><span class="p">)</span><span class="o">*</span><span class="n">ksen</span><span class="o">+</span><span class="mi">1</span>
<a name="ln-528"></a>          <span class="n">kend</span>   <span class="o">=</span>  <span class="p">(</span><span class="n">proc</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">ksen</span>
<a name="ln-529"></a>       <span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="n">kstart</span><span class="p">,</span><span class="n">kend</span>
<a name="ln-530"></a>       <span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">jmax</span>
<a name="ln-531"></a>       <span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">imax</span>
<a name="ln-532"></a>          <span class="n">ii</span> <span class="o">=</span> <span class="n">ii</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-533"></a>          <span class="n">p</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">bufout</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span> 
<a name="ln-534"></a>       <span class="n">enddo</span>
<a name="ln-535"></a>       <span class="n">enddo</span>
<a name="ln-536"></a>       <span class="n">enddo</span>
<a name="ln-537"></a>       <span class="n">enddo</span>
<a name="ln-538"></a><span class="c">! </span>
<a name="ln-539"></a><span class="c">!</span>
<a name="ln-540"></a>       <span class="k">call </span><span class="n">barrou</span><span class="p">()</span>
<a name="ln-541"></a>       <span class="n">endif</span>
<a name="ln-542"></a><span class="c">!</span>
<a name="ln-543"></a>       <span class="k">return</span>
<a name="ln-544"></a><span class="k">       end subroutine </span><span class="n">ALL_ALL_j2</span>
<a name="ln-545"></a>
<a name="ln-546"></a><span class="c">! subroutine poisr</span>
<a name="ln-547"></a>
<a name="ln-548"></a>      <span class="k">SUBROUTINE </span><span class="n">poisr</span><span class="p">(</span><span class="n">rhs</span><span class="p">,</span><span class="n">dx</span><span class="p">,</span><span class="n">dxh</span><span class="p">,</span><span class="n">dy</span><span class="p">,</span><span class="n">dz</span><span class="p">,</span><span class="n">dzh</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-549"></a>                       <span class="n">ibc1</span><span class="p">,</span><span class="n">ibc2</span><span class="p">,</span><span class="n">kbc1</span><span class="p">,</span><span class="n">kbc2</span><span class="p">,</span><span class="n">ksen</span><span class="p">)</span>
<a name="ln-550"></a><span class="c">!</span>
<a name="ln-551"></a><span class="c">! CHANGES:</span>
<a name="ln-552"></a><span class="c">! includes jtot and ksen (calculated in poisson.f) in header</span>
<a name="ln-553"></a><span class="c">!          help array rhst with dimensions (imax,jtot,ksen)</span>
<a name="ln-554"></a><span class="c">!          ALL_ALL copy rhs to rhst and back for FFT&#39;s</span>
<a name="ln-555"></a><span class="c">!           </span>
<a name="ln-556"></a><span class="c">!  ibc?=1: neumann</span>
<a name="ln-557"></a><span class="c">!  ibc?=2: periodic</span>
<a name="ln-558"></a><span class="c">!  ibc?=3: dirichlet</span>
<a name="ln-559"></a><span class="c">!</span>
<a name="ln-560"></a><span class="c">! only FFT in j-direction, cyclic reduction in the others</span>
<a name="ln-561"></a>
<a name="ln-562"></a><span class="c">!      include&#39;param.txt&#39;</span>
<a name="ln-563"></a><span class="c">!     include &#39;mpif.h&#39;</span>
<a name="ln-564"></a><span class="c">!     include &#39;mpi_cons.txt&#39;</span>
<a name="ln-565"></a>  <span class="k">use </span><span class="n">modglobal</span><span class="p">,</span> <span class="k">only</span> <span class="p">:</span> <span class="n">imax</span><span class="p">,</span><span class="n">isen</span><span class="p">,</span><span class="n">jmax</span><span class="p">,</span><span class="n">jsen</span><span class="p">,</span><span class="n">jtot</span><span class="p">,</span><span class="n">kmax</span><span class="p">,</span><span class="n">poisrcheck</span>
<a name="ln-566"></a>  <span class="k">use </span><span class="n">modfields</span><span class="p">,</span> <span class="k">only</span> <span class="p">:</span> <span class="n">worksave</span>
<a name="ln-567"></a>  <span class="k">use </span><span class="n">modmpi</span><span class="p">,</span>    <span class="k">only</span> <span class="p">:</span> <span class="n">myid</span><span class="p">,</span><span class="n">comm3d</span><span class="p">,</span><span class="n">mpierr</span><span class="p">,</span><span class="n">my_real</span><span class="p">,</span><span class="n">nprocs</span><span class="p">,</span> <span class="n">barrou</span><span class="p">,</span><span class="n">MPI_SUM</span>
<a name="ln-568"></a>      <span class="k">implicit none</span>
<a name="ln-569"></a>
<a name="ln-570"></a><span class="c">! authors: m.j.b.m. pourquie, b.j. boersma</span>
<a name="ln-571"></a>
<a name="ln-572"></a>      <span class="kt">integer </span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">ksen</span>
<a name="ln-573"></a>      <span class="kt">real </span><span class="n">rhs</span><span class="p">(</span><span class="mi">0</span><span class="p">:</span><span class="n">imax</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="n">jmax</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="n">kmax</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span><span class="n">dx</span><span class="p">(</span><span class="mi">0</span><span class="p">:</span><span class="n">IMAX</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span><span class="n">dxh</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">IMAX</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span><span class="n">dy</span>
<a name="ln-574"></a>      <span class="kt">real</span><span class="p">,</span> <span class="k">allocatable</span><span class="p">,</span> <span class="k">dimension</span><span class="p">(:,:,:)</span> <span class="kd">::</span>  <span class="n">rhs2</span>
<a name="ln-575"></a>      <span class="kt">real</span><span class="p">,</span> <span class="k">allocatable</span><span class="p">,</span> <span class="k">dimension</span><span class="p">(:)</span> <span class="kd">::</span>  <span class="n">work</span>
<a name="ln-576"></a>      <span class="kt">integer  </span><span class="n">ier</span><span class="p">,</span> <span class="n">iperio</span><span class="p">,</span> <span class="n">kperio</span>
<a name="ln-577"></a>      <span class="kt">integer  </span><span class="n">ibc1</span><span class="p">,</span><span class="n">ibc2</span><span class="p">,</span><span class="n">kbc1</span><span class="p">,</span><span class="n">kbc2</span>
<a name="ln-578"></a>      <span class="kt">real </span><span class="n">dz</span><span class="p">(</span><span class="mi">0</span><span class="p">:</span><span class="n">kmax</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span><span class="n">dzh</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">kmax</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span><span class="n">pi</span>       <span class="c">!   dz: kb-1:ke+1,  dzh: kb:ke+1</span>
<a name="ln-579"></a>      <span class="kt">real </span><span class="n">a</span><span class="p">(</span><span class="n">imax</span><span class="p">),</span><span class="n">b</span><span class="p">(</span><span class="n">imax</span><span class="p">),</span><span class="n">c</span><span class="p">(</span><span class="n">imax</span><span class="p">),</span><span class="n">bin</span><span class="p">(</span><span class="n">imax</span><span class="p">)</span>
<a name="ln-580"></a>      <span class="kt">real </span><span class="n">az</span><span class="p">(</span><span class="n">kmax</span><span class="p">),</span><span class="n">bz</span><span class="p">(</span><span class="n">kmax</span><span class="p">),</span><span class="n">cz</span><span class="p">(</span><span class="n">kmax</span><span class="p">)</span>
<a name="ln-581"></a>      <span class="kt">real </span><span class="n">yrt</span><span class="p">(</span><span class="n">jtot</span><span class="p">)</span>
<a name="ln-582"></a>      <span class="kt">real</span><span class="p">,</span> <span class="k">allocatable</span><span class="p">,</span> <span class="k">dimension</span><span class="p">(:,:)</span> <span class="kd">::</span>  <span class="n">vfftj</span>
<a name="ln-583"></a>      <span class="kt">real</span><span class="p">,</span> <span class="k">allocatable</span><span class="p">,</span> <span class="k">dimension</span><span class="p">(:,:)</span> <span class="kd">::</span>  <span class="n">y</span>
<a name="ln-584"></a>      <span class="kt">real </span><span class="n">wj</span><span class="p">(</span><span class="n">jtot</span><span class="o">+</span><span class="mi">15</span><span class="p">)</span>
<a name="ln-585"></a>      <span class="kt">real   </span><span class="n">angle</span><span class="p">,</span> <span class="n">tst</span>
<a name="ln-586"></a>      <span class="kt">integer </span><span class="n">ipos</span><span class="p">,</span> <span class="n">jv</span>
<a name="ln-587"></a>      <span class="kt">real  </span><span class="n">suml</span><span class="p">,</span> <span class="nb">sum</span>
<a name="ln-588"></a><span class="c">!</span>
<a name="ln-589"></a><span class="c">! test write</span>
<a name="ln-590"></a><span class="c">!     write(6,*)&#39;POISR, kmax, ksen, nprocs,jmax,jtot &#39;,kmax, ksen, nprocs ,jmax,jtot</span>
<a name="ln-591"></a>      <span class="k">allocate</span><span class="p">(</span><span class="n">rhs2</span><span class="p">(</span><span class="n">imax</span><span class="p">,</span><span class="n">jtot</span><span class="p">,</span><span class="n">ksen</span><span class="p">))</span>
<a name="ln-592"></a>      <span class="k">allocate</span><span class="p">(</span><span class="n">work</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">imax</span><span class="o">*</span><span class="n">jmax</span><span class="o">*</span><span class="n">kmax</span><span class="p">))</span>
<a name="ln-593"></a>      <span class="k">allocate</span><span class="p">(</span><span class="n">vfftj</span><span class="p">(</span><span class="n">imax</span><span class="o">*</span><span class="n">ksen</span><span class="p">,</span><span class="n">jtot</span><span class="p">))</span>
<a name="ln-594"></a>      <span class="k">allocate</span><span class="p">(</span><span class="n">y</span><span class="p">(</span><span class="n">imax</span><span class="p">,</span><span class="n">kmax</span><span class="p">))</span>
<a name="ln-595"></a>
<a name="ln-596"></a>      <span class="n">pi</span><span class="o">=</span><span class="mf">4.</span><span class="o">*</span><span class="nb">atan</span><span class="p">(</span><span class="mf">1.</span><span class="p">)</span>
<a name="ln-597"></a>      <span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">imax</span>
<a name="ln-598"></a>         <span class="n">a</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span>  <span class="mf">1.</span><span class="o">/</span><span class="p">(</span><span class="n">dx</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="n">dxh</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
<a name="ln-599"></a>         <span class="n">c</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span>  <span class="mf">1.</span><span class="o">/</span><span class="p">(</span><span class="n">dx</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="n">dxh</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
<a name="ln-600"></a>         <span class="n">b</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span>  <span class="o">-</span> <span class="p">(</span><span class="n">a</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="n">c</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
<a name="ln-601"></a>      <span class="n">enddo</span>
<a name="ln-602"></a>
<a name="ln-603"></a>      <span class="k">if</span><span class="p">((</span><span class="n">ibc1</span><span class="p">).</span><span class="n">eq</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span><span class="k">then</span>
<a name="ln-604"></a><span class="c">! Neumann</span>
<a name="ln-605"></a>         <span class="n">b</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>    <span class="o">=</span> <span class="n">b</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>    <span class="o">+</span> <span class="n">a</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-606"></a>      <span class="n">elseif</span><span class="p">(</span><span class="n">ibc1</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mi">2</span><span class="p">)</span><span class="k">then</span>
<a name="ln-607"></a><span class="c">! periodic</span>
<a name="ln-608"></a>         <span class="n">b</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>    <span class="o">=</span> <span class="n">b</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>    
<a name="ln-609"></a>      <span class="n">elseif</span><span class="p">(</span><span class="n">ibc1</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mi">3</span><span class="p">)</span><span class="k">then</span>
<a name="ln-610"></a><span class="c">! Dir</span>
<a name="ln-611"></a>         <span class="n">b</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>    <span class="o">=</span> <span class="n">b</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>    <span class="o">-</span> <span class="n">a</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-612"></a>      <span class="n">endif</span>
<a name="ln-613"></a>
<a name="ln-614"></a>      <span class="k">if</span><span class="p">((</span><span class="n">ibc2</span><span class="p">).</span><span class="n">eq</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span><span class="k">then</span>
<a name="ln-615"></a><span class="c">! Neumann</span>
<a name="ln-616"></a>         <span class="n">b</span><span class="p">(</span><span class="n">imax</span><span class="p">)</span> <span class="o">=</span> <span class="n">b</span><span class="p">(</span><span class="n">imax</span><span class="p">)</span> <span class="o">+</span> <span class="n">c</span><span class="p">(</span><span class="n">imax</span><span class="p">)</span>
<a name="ln-617"></a>      <span class="n">elseif</span><span class="p">((</span><span class="n">ibc2</span><span class="p">).</span><span class="n">eq</span><span class="p">.</span><span class="mi">2</span><span class="p">)</span><span class="k">then</span>
<a name="ln-618"></a><span class="k">         </span><span class="n">b</span><span class="p">(</span><span class="n">imax</span><span class="p">)</span> <span class="o">=</span> <span class="n">b</span><span class="p">(</span><span class="n">imax</span><span class="p">)</span> 
<a name="ln-619"></a>      <span class="n">elseif</span><span class="p">((</span><span class="n">ibc2</span><span class="p">).</span><span class="n">eq</span><span class="p">.</span><span class="mi">3</span><span class="p">)</span><span class="k">then</span>
<a name="ln-620"></a><span class="c">!         b(imax) = b(imax) - c(kmax)   ! Jasper T. : bug? Should be b(imax) - c(imax)?</span>
<a name="ln-621"></a>         <span class="n">b</span><span class="p">(</span><span class="n">imax</span><span class="p">)</span> <span class="o">=</span> <span class="n">b</span><span class="p">(</span><span class="n">imax</span><span class="p">)</span> <span class="o">-</span> <span class="n">c</span><span class="p">(</span><span class="n">imax</span><span class="p">)</span> 
<a name="ln-622"></a>      <span class="n">endif</span>
<a name="ln-623"></a>      
<a name="ln-624"></a>
<a name="ln-625"></a>      <span class="k">if</span><span class="p">(</span><span class="n">ibc1</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="mi">2</span><span class="p">)</span><span class="k">then</span>
<a name="ln-626"></a><span class="k">      </span><span class="n">c</span><span class="p">(</span><span class="n">imax</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.</span>
<a name="ln-627"></a>      <span class="n">a</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>    <span class="o">=</span> <span class="mf">0.</span>
<a name="ln-628"></a>      <span class="n">endif</span>
<a name="ln-629"></a><span class="c">!     do i=1,imax</span>
<a name="ln-630"></a><span class="c">!        write(6,*)&#39;i, abc(i)&#39;,i, a(i),b(i),c(i)</span>
<a name="ln-631"></a><span class="c">!     enddo</span>
<a name="ln-632"></a>      
<a name="ln-633"></a><span class="c">!</span>
<a name="ln-634"></a><span class="c">! fill coefficients in k-direction</span>
<a name="ln-635"></a>
<a name="ln-636"></a><span class="c">!      do k=1,kmax                          ! Mathieu&#39;s version</span>
<a name="ln-637"></a><span class="c">!         az(k) =  1./(dz(k)*dzh(k-1))</span>
<a name="ln-638"></a><span class="c">!         cz(k) =  1./(dz(k)*dzh(k))</span>
<a name="ln-639"></a><span class="c">!         bz(k) =  - (az(k) + cz(k))</span>
<a name="ln-640"></a><span class="c">!      enddo</span>
<a name="ln-641"></a>
<a name="ln-642"></a>      <span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">kmax</span>
<a name="ln-643"></a>         <span class="n">az</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span>  <span class="mf">1.</span><span class="o">/</span><span class="p">(</span><span class="n">dz</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">dzh</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
<a name="ln-644"></a>         <span class="n">cz</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span>  <span class="mf">1.</span><span class="o">/</span><span class="p">(</span><span class="n">dz</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">dzh</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
<a name="ln-645"></a>         <span class="n">bz</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span>  <span class="o">-</span> <span class="p">(</span><span class="n">az</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">+</span> <span class="n">cz</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
<a name="ln-646"></a>      <span class="n">enddo</span>
<a name="ln-647"></a>
<a name="ln-648"></a><span class="c">!</span>
<a name="ln-649"></a><span class="c">! BC:</span>
<a name="ln-650"></a><span class="c">!</span>
<a name="ln-651"></a><span class="c">!periodic     bz(1)    = bz(1) - az(1)</span>
<a name="ln-652"></a><span class="c">!periodic      az(1)    = 0.</span>
<a name="ln-653"></a><span class="c">!periodic     bz(kmax) = bz(kmax) - az(kmax)</span>
<a name="ln-654"></a><span class="c">!periodic      az(kmax) = 0.</span>
<a name="ln-655"></a>      <span class="k">if</span><span class="p">((</span><span class="n">kbc1</span><span class="p">).</span><span class="n">eq</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span><span class="k">then</span>
<a name="ln-656"></a><span class="c">! Neumann</span>
<a name="ln-657"></a>         <span class="n">bz</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>    <span class="o">=</span> <span class="n">bz</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>    <span class="o">+</span> <span class="n">az</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-658"></a>      <span class="n">elseif</span><span class="p">(</span><span class="n">kbc1</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mi">2</span><span class="p">)</span><span class="k">then</span>
<a name="ln-659"></a><span class="c">! periodic</span>
<a name="ln-660"></a>         <span class="n">bz</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>    <span class="o">=</span> <span class="n">bz</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>    
<a name="ln-661"></a>      <span class="n">endif</span>
<a name="ln-662"></a>
<a name="ln-663"></a>      <span class="k">if</span><span class="p">((</span><span class="n">kbc2</span><span class="p">).</span><span class="n">eq</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span><span class="k">then</span>
<a name="ln-664"></a><span class="c">! Neumann</span>
<a name="ln-665"></a>         <span class="n">bz</span><span class="p">(</span><span class="n">kmax</span><span class="p">)</span> <span class="o">=</span> <span class="n">bz</span><span class="p">(</span><span class="n">kmax</span><span class="p">)</span> <span class="o">+</span> <span class="n">cz</span><span class="p">(</span><span class="n">kmax</span><span class="p">)</span>
<a name="ln-666"></a>      <span class="n">elseif</span><span class="p">((</span><span class="n">kbc2</span><span class="p">).</span><span class="n">eq</span><span class="p">.</span><span class="mi">2</span><span class="p">)</span><span class="k">then</span>
<a name="ln-667"></a><span class="k">         </span><span class="n">bz</span><span class="p">(</span><span class="n">kmax</span><span class="p">)</span> <span class="o">=</span> <span class="n">bz</span><span class="p">(</span><span class="n">kmax</span><span class="p">)</span> 
<a name="ln-668"></a>      <span class="n">elseif</span><span class="p">((</span><span class="n">kbc2</span><span class="p">).</span><span class="n">eq</span><span class="p">.</span><span class="mi">3</span><span class="p">)</span><span class="k">then</span>
<a name="ln-669"></a><span class="c">!</span>
<a name="ln-670"></a><span class="c">! p = 0.</span>
<a name="ln-671"></a>
<a name="ln-672"></a>         <span class="n">bz</span><span class="p">(</span><span class="n">kmax</span><span class="p">)</span> <span class="o">=</span> <span class="n">bz</span><span class="p">(</span><span class="n">kmax</span><span class="p">)</span>  <span class="o">-</span> <span class="n">cz</span><span class="p">(</span><span class="n">kmax</span><span class="p">)</span>
<a name="ln-673"></a>      <span class="n">endif</span>
<a name="ln-674"></a>      <span class="k">if</span><span class="p">(</span><span class="n">kbc1</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="mi">2</span><span class="p">)</span><span class="k">then</span>
<a name="ln-675"></a><span class="k">      </span><span class="n">cz</span><span class="p">(</span><span class="n">kmax</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.</span>
<a name="ln-676"></a>      <span class="n">az</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>    <span class="o">=</span> <span class="mf">0.</span>
<a name="ln-677"></a>      <span class="n">endif</span>
<a name="ln-678"></a><span class="c">!     do k=1,kmax</span>
<a name="ln-679"></a><span class="c">!        write(6,*)&#39;k, abc(k)&#39;,k, az(k),bz(k),cz(k)</span>
<a name="ln-680"></a><span class="c">!     enddo</span>
<a name="ln-681"></a><span class="c">!</span>
<a name="ln-682"></a><span class="c">! initialise for FFT</span>
<a name="ln-683"></a>
<a name="ln-684"></a><span class="c">! PAR</span>
<a name="ln-685"></a><span class="c">!     call vrffti(jmax,wj)</span>
<a name="ln-686"></a>      <span class="k">call </span><span class="n">vrffti</span><span class="p">(</span><span class="n">jtot</span><span class="p">,</span><span class="n">wj</span><span class="p">)</span>
<a name="ln-687"></a><span class="c">!         </span>
<a name="ln-688"></a>
<a name="ln-689"></a>      <span class="n">yrt</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span><span class="mf">0.</span>
<a name="ln-690"></a><span class="c">! PAR</span>
<a name="ln-691"></a><span class="c">!     yrt(jmax)=-4./(dy*dy)</span>
<a name="ln-692"></a>      <span class="n">yrt</span><span class="p">(</span><span class="n">jtot</span><span class="p">)</span><span class="o">=-</span><span class="mf">4.</span><span class="o">/</span><span class="p">(</span><span class="n">dy</span><span class="o">*</span><span class="n">dy</span><span class="p">)</span>
<a name="ln-693"></a>      <span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">jtot</span><span class="p">,</span><span class="mi">2</span>
<a name="ln-694"></a><span class="c">!</span>
<a name="ln-695"></a><span class="c">! 2.*(cos2(alpha) -1) = 2.*(-2.*sin(alpha)**2</span>
<a name="ln-696"></a>
<a name="ln-697"></a>      <span class="n">yrt</span><span class="p">(</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mf">4.</span><span class="o">/</span><span class="p">(</span><span class="n">dy</span><span class="o">*</span><span class="n">dy</span><span class="p">))</span><span class="o">*</span><span class="p">(</span><span class="nb">sin</span><span class="p">(</span><span class="nb">float</span><span class="p">((</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">*</span><span class="n">pi</span><span class="o">/</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">jtot</span><span class="p">)))</span><span class="o">**</span><span class="mi">2</span>
<a name="ln-698"></a>      <span class="n">yrt</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">=</span> <span class="n">yrt</span><span class="p">(</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-699"></a>      <span class="n">enddo</span> 
<a name="ln-700"></a>
<a name="ln-701"></a><span class="c">!     help = rhs</span>
<a name="ln-702"></a><span class="c">!</span>
<a name="ln-703"></a><span class="c">! sum check (comment out if not deeded)</span>
<a name="ln-704"></a><span class="c">!</span>
<a name="ln-705"></a><span class="c">!!      suml = 0.</span>
<a name="ln-706"></a><span class="c">!!      do k=1,kmax</span>
<a name="ln-707"></a><span class="c">!!         do j=1,jmax</span>
<a name="ln-708"></a><span class="c">!!         do i=1,imax</span>
<a name="ln-709"></a><span class="c">!!         suml = suml + rhs(i,j,k)*dx(i)*dy*dz(k)</span>
<a name="ln-710"></a><span class="c">!!         enddo</span>
<a name="ln-711"></a><span class="c">!!         enddo</span>
<a name="ln-712"></a><span class="c">!!      enddo</span>
<a name="ln-713"></a><span class="c">!!      call MPI_ALLREDUCE(suml, sum, 1, MY_REAL, MPI_SUM, comm3d,mpierr)</span>
<a name="ln-714"></a><span class="c">!!      if(myid.eq.0) write(6,*)&#39;solver sum = &#39;, sum</span>
<a name="ln-715"></a><span class="c">!</span>
<a name="ln-716"></a><span class="c">! end sum check</span>
<a name="ln-717"></a><span class="c">!</span>
<a name="ln-718"></a>
<a name="ln-719"></a>      <span class="k">call </span><span class="n">barrou</span><span class="p">()</span>
<a name="ln-720"></a>      <span class="k">call </span><span class="n">ALL_ALL_j2</span><span class="p">(</span><span class="n">rhs</span><span class="p">,</span><span class="n">rhs2</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">ksen</span><span class="p">)</span>
<a name="ln-721"></a>      <span class="k">call </span><span class="n">barrou</span><span class="p">()</span>
<a name="ln-722"></a>
<a name="ln-723"></a>      <span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">ksen</span>
<a name="ln-724"></a>      <span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">imax</span>
<a name="ln-725"></a>      <span class="n">ipos</span><span class="o">=</span><span class="p">(</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">imax</span><span class="o">+</span><span class="n">i</span>
<a name="ln-726"></a>      <span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">jtot</span>
<a name="ln-727"></a>      <span class="n">vfftj</span><span class="p">(</span><span class="n">ipos</span><span class="p">,</span><span class="n">j</span><span class="p">)</span><span class="o">=</span><span class="n">rhs2</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>
<a name="ln-728"></a><span class="c">!     suml = suml + rhs2(i,j,k)*dy*dz(k)*dx(i)</span>
<a name="ln-729"></a>      <span class="n">enddo</span>
<a name="ln-730"></a>      <span class="n">enddo</span>
<a name="ln-731"></a>      <span class="n">enddo</span>
<a name="ln-732"></a><span class="c">!     call MPI_ALLREDUCE(suml, sum, 1, MY_REAL, MPI_SUM, comm3d,mpierr)</span>
<a name="ln-733"></a>
<a name="ln-734"></a><span class="c">!     if(myid.eq.0) write(6,*)&#39;solver sum = &#39;, sum</span>
<a name="ln-735"></a><span class="c">!</span>
<a name="ln-736"></a>      <span class="k">call </span><span class="n">vrfftf</span><span class="p">(</span><span class="n">imax</span><span class="o">*</span><span class="n">ksen</span><span class="p">,</span><span class="n">jtot</span><span class="p">,</span><span class="n">vfftj</span><span class="p">,</span><span class="n">rhs2</span><span class="p">,</span><span class="n">imax</span><span class="o">*</span><span class="n">ksen</span><span class="p">,</span><span class="n">wj</span><span class="p">)</span>
<a name="ln-737"></a><span class="c">!</span>
<a name="ln-738"></a><span class="c">!      goto 1234</span>
<a name="ln-739"></a>      <span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">ksen</span>
<a name="ln-740"></a>      <span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">imax</span>
<a name="ln-741"></a>      <span class="n">ipos</span><span class="o">=</span><span class="p">(</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">imax</span><span class="o">+</span><span class="n">i</span>
<a name="ln-742"></a>      <span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">jtot</span>
<a name="ln-743"></a>      <span class="n">rhs2</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">vfftj</span><span class="p">(</span><span class="n">ipos</span><span class="p">,</span><span class="n">j</span><span class="p">)</span>
<a name="ln-744"></a>      <span class="n">enddo</span>
<a name="ln-745"></a>      <span class="n">enddo</span>
<a name="ln-746"></a>      <span class="n">enddo</span>
<a name="ln-747"></a>      <span class="k">call </span><span class="n">barrou</span><span class="p">()</span>
<a name="ln-748"></a>      <span class="k">call </span><span class="n">ALL_ALL_j2</span><span class="p">(</span><span class="n">rhs</span><span class="p">,</span><span class="n">rhs2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">ksen</span><span class="p">)</span>
<a name="ln-749"></a>      <span class="k">call </span><span class="n">barrou</span><span class="p">()</span>
<a name="ln-750"></a><span class="c">!     call sumchk3(rhs,imax,jmax,kmax,8,1)</span>
<a name="ln-751"></a>
<a name="ln-752"></a><span class="c">! PAR CHECK!!!</span>
<a name="ln-753"></a>      <span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">jmax</span>       <span class="c">! begin loop over angles</span>
<a name="ln-754"></a><span class="c">!     do j=1,jtot       ! begin loop over angles</span>
<a name="ln-755"></a>
<a name="ln-756"></a><span class="c">!</span>
<a name="ln-757"></a><span class="c">! add proper part to diagonal</span>
<a name="ln-758"></a>
<a name="ln-759"></a>      <span class="n">jv</span> <span class="o">=</span> <span class="n">j</span> <span class="o">+</span> <span class="n">myid</span><span class="o">*</span><span class="n">jmax</span>
<a name="ln-760"></a>      <span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">imax</span>
<a name="ln-761"></a><span class="c">! PAR CHECK!!</span>
<a name="ln-762"></a>      <span class="n">bin</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">=</span><span class="n">b</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="n">yrt</span><span class="p">(</span><span class="n">jv</span><span class="p">)</span><span class="c">!!!!!!!!!/(Rp(i)**2)</span>
<a name="ln-763"></a>      <span class="n">enddo</span>
<a name="ln-764"></a>
<a name="ln-765"></a><span class="c">!ATTT      do k=1,ksen</span>
<a name="ln-766"></a>      <span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">kmax</span>
<a name="ln-767"></a>      <span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">imax</span>
<a name="ln-768"></a>         <span class="n">ipos</span><span class="o">=</span><span class="p">(</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">imax</span><span class="o">+</span><span class="n">i</span>
<a name="ln-769"></a><span class="c">!PAR CHECK</span>
<a name="ln-770"></a>         <span class="n">y</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">rhs</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="c">!vfftj(ipos,j)</span>
<a name="ln-771"></a>      <span class="n">enddo</span>
<a name="ln-772"></a>      <span class="n">enddo</span>
<a name="ln-773"></a>      <span class="n">iperio</span><span class="o">=</span><span class="mi">1</span>
<a name="ln-774"></a>      <span class="n">kperio</span><span class="o">=</span><span class="mi">1</span>
<a name="ln-775"></a>      <span class="k">if</span><span class="p">(</span><span class="n">ibc1</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mi">2</span><span class="p">)</span><span class="n">iperio</span><span class="o">=</span><span class="mi">0</span> <span class="c">! i periodic</span>
<a name="ln-776"></a>      <span class="k">if</span><span class="p">(</span><span class="n">kbc1</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mi">2</span><span class="p">)</span><span class="n">kperio</span><span class="o">=</span><span class="mi">0</span> <span class="c">! k periodic</span>
<a name="ln-777"></a>      <span class="k">if</span><span class="p">(</span><span class="n">poisrcheck</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-778"></a><span class="k">      </span><span class="n">poisrcheck</span><span class="o">=</span><span class="mi">1</span>
<a name="ln-779"></a>      <span class="k">CALL </span><span class="n">BLKTRI</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">kperio</span><span class="p">,</span><span class="n">kmax</span><span class="p">,</span><span class="n">az</span><span class="p">,</span><span class="n">bz</span><span class="p">,</span><span class="n">cz</span><span class="p">,</span><span class="n">iperio</span><span class="p">,</span><span class="n">imax</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">bin</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">imax</span><span class="p">,</span><span class="n">y</span> <span class="p">&amp;</span>
<a name="ln-780"></a><span class="c">!</span>
<a name="ln-781"></a><span class="c">!                   ^ 0 for periodic BC</span>
<a name="ln-782"></a>           <span class="p">,</span><span class="n">ier</span><span class="p">,</span><span class="n">work</span><span class="p">)</span>
<a name="ln-783"></a><span class="c">!     write(6,*)&#39;ier = &#39;, ier, iperio, kperio</span>
<a name="ln-784"></a><span class="c">!     if(ier.ne.0)stop &#39;IER&#39;</span>
<a name="ln-785"></a>      <span class="n">worksave</span> <span class="o">=</span> <span class="n">work</span>
<a name="ln-786"></a>      <span class="k">write</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s1">&#39;First time step in POISR, poisrcheck=&#39;</span><span class="p">,</span> <span class="n">poisrcheck</span> 
<a name="ln-787"></a>      <span class="k">end if</span>
<a name="ln-788"></a><span class="k">      CALL </span><span class="n">BLKTRI</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">kperio</span><span class="p">,</span><span class="n">kmax</span><span class="p">,</span><span class="n">az</span><span class="p">,</span><span class="n">bz</span><span class="p">,</span><span class="n">cz</span><span class="p">,</span><span class="n">iperio</span><span class="p">,</span><span class="n">imax</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">bin</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">imax</span><span class="p">,</span><span class="n">y</span> <span class="p">&amp;</span>
<a name="ln-789"></a>           <span class="p">,</span><span class="n">ier</span><span class="p">,</span><span class="n">worksave</span><span class="p">)</span>
<a name="ln-790"></a><span class="c">!</span>
<a name="ln-791"></a><span class="c">!     write(6,*)&#39;myid, ier = &#39;, myid, ier, j</span>
<a name="ln-792"></a><span class="c">!      if(ier.ne.0)stop &#39;IER&#39;</span>
<a name="ln-793"></a>
<a name="ln-794"></a>      <span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">kmax</span>
<a name="ln-795"></a>      <span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">imax</span>
<a name="ln-796"></a>         <span class="n">ipos</span><span class="o">=</span><span class="p">(</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">imax</span><span class="o">+</span><span class="n">i</span>
<a name="ln-797"></a><span class="c">!PAR CHECK</span>
<a name="ln-798"></a><span class="c">!        vfftj(ipos,j) = y(i,k) </span>
<a name="ln-799"></a>         <span class="n">rhs</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">y</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> 
<a name="ln-800"></a>      <span class="n">enddo</span>
<a name="ln-801"></a>      <span class="n">enddo</span>
<a name="ln-802"></a>
<a name="ln-803"></a>      <span class="n">enddo</span>         <span class="c">! end loop over angles</span>
<a name="ln-804"></a>
<a name="ln-805"></a><span class="mi">1234</span>  <span class="k">continue</span>
<a name="ln-806"></a><span class="c">!     call sumchk3(rhs,imax,jmax,kmax,9,1)</span>
<a name="ln-807"></a><span class="c">!</span>
<a name="ln-808"></a>      <span class="k">call </span><span class="n">barrou</span><span class="p">()</span>
<a name="ln-809"></a>      <span class="k">call </span><span class="n">ALL_ALL_j2</span><span class="p">(</span><span class="n">rhs</span><span class="p">,</span><span class="n">rhs2</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">ksen</span><span class="p">)</span>
<a name="ln-810"></a>      <span class="k">call </span><span class="n">barrou</span><span class="p">()</span>
<a name="ln-811"></a><span class="c">!</span>
<a name="ln-812"></a>      <span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">ksen</span>
<a name="ln-813"></a>      <span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">imax</span>
<a name="ln-814"></a>      <span class="n">ipos</span><span class="o">=</span><span class="p">(</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">imax</span><span class="o">+</span><span class="n">i</span>
<a name="ln-815"></a>      <span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">jtot</span>
<a name="ln-816"></a>      <span class="n">vfftj</span><span class="p">(</span><span class="n">ipos</span><span class="p">,</span><span class="n">j</span><span class="p">)</span><span class="o">=</span><span class="n">rhs2</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>
<a name="ln-817"></a>      <span class="n">enddo</span>
<a name="ln-818"></a>      <span class="n">enddo</span>
<a name="ln-819"></a>      <span class="n">enddo</span>
<a name="ln-820"></a>
<a name="ln-821"></a>
<a name="ln-822"></a>      <span class="k">call </span><span class="n">vrfftb</span><span class="p">(</span><span class="n">imax</span><span class="o">*</span><span class="n">ksen</span><span class="p">,</span><span class="n">jtot</span><span class="p">,</span><span class="n">vfftj</span><span class="p">,</span><span class="n">rhs2</span><span class="p">,</span><span class="n">imax</span><span class="o">*</span><span class="n">ksen</span><span class="p">,</span><span class="n">wj</span><span class="p">)</span>
<a name="ln-823"></a><span class="c">!!ATTTT      dok=1,kmax</span>
<a name="ln-824"></a>      <span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">ksen</span>
<a name="ln-825"></a>      <span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">imax</span>
<a name="ln-826"></a>      <span class="n">ipos</span><span class="o">=</span><span class="p">(</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">imax</span><span class="o">+</span><span class="n">i</span>
<a name="ln-827"></a>      <span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">jtot</span>
<a name="ln-828"></a>      <span class="n">rhs2</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">=</span><span class="n">vfftj</span><span class="p">(</span><span class="n">ipos</span><span class="p">,</span><span class="n">j</span><span class="p">)</span>
<a name="ln-829"></a><span class="c">!     if(abs(rhs(i,j,k)-help(i,j,k)).gt.1.e-13)then</span>
<a name="ln-830"></a><span class="c">!       write(6,*)&#39;ERRR&#39;, i, j, k, rhs(i,j,k), help(i,j,k)</span>
<a name="ln-831"></a><span class="c">!     endif</span>
<a name="ln-832"></a>      <span class="n">enddo</span>
<a name="ln-833"></a>      <span class="n">enddo</span>
<a name="ln-834"></a>      <span class="n">enddo</span>
<a name="ln-835"></a>      <span class="k">call </span><span class="n">barrou</span><span class="p">()</span>
<a name="ln-836"></a>      <span class="k">call </span><span class="n">ALL_ALL_j2</span><span class="p">(</span><span class="n">rhs</span><span class="p">,</span><span class="n">rhs2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">ksen</span><span class="p">)</span>
<a name="ln-837"></a>      <span class="k">call </span><span class="n">barrou</span><span class="p">()</span>
<a name="ln-838"></a>
<a name="ln-839"></a>
<a name="ln-840"></a><span class="c">!     call sumchk3(rhs,imax,jmax,kmax,2,1)</span>
<a name="ln-841"></a>
<a name="ln-842"></a>      
<a name="ln-843"></a>      <span class="k">deallocate</span><span class="p">(</span><span class="n">rhs2</span><span class="p">)</span>
<a name="ln-844"></a>      <span class="k">deallocate</span><span class="p">(</span><span class="n">work</span><span class="p">)</span>
<a name="ln-845"></a>      <span class="k">deallocate</span><span class="p">(</span><span class="n">vfftj</span><span class="p">)</span>
<a name="ln-846"></a>      <span class="k">deallocate</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
<a name="ln-847"></a>      <span class="k">return</span>
<a name="ln-848"></a><span class="k">  end subroutine </span><span class="n">poisr</span>
<a name="ln-849"></a>
<a name="ln-850"></a> <span class="k">subroutine </span><span class="n">solmpj</span><span class="p">(</span><span class="n">p1</span><span class="p">)</span>
<a name="ln-851"></a><span class="c">! version: working version, barrou&#39;s removed,</span>
<a name="ln-852"></a><span class="c">!          correct timing fft&#39;s</span>
<a name="ln-853"></a><span class="c">!          AAPC with MPI-provided routines</span>
<a name="ln-854"></a><span class="c">!          uses only 2 AAPC, using MPI-rovided routines,</span>
<a name="ln-855"></a><span class="c">!          to pre-distribute the arrays s.t. complete</span>
<a name="ln-856"></a><span class="c">!          2-D planes are present on each processor</span>
<a name="ln-857"></a><span class="c">!          uses ALLTOALL instead of ALLTOALLV</span>
<a name="ln-858"></a><span class="c">!          ONLY distribution in j-direction allowed</span>
<a name="ln-859"></a>
<a name="ln-860"></a><span class="c">! NOTE: input array p1 is supposed to have the ip1ray distribution,</span>
<a name="ln-861"></a><span class="c">!       i.e. the entire range of the first index must be present on</span>
<a name="ln-862"></a><span class="c">!       each processor</span>
<a name="ln-863"></a>
<a name="ln-864"></a><span class="c">!******************************************************************</span>
<a name="ln-865"></a><span class="c">!********************  FAST POISSON SOLVER ************************</span>
<a name="ln-866"></a><span class="c">!*****                                                        *****</span>
<a name="ln-867"></a><span class="c">!***               P_xx + P_yy + P_zz  =f(x,y,z)                ***</span>
<a name="ln-868"></a><span class="c">!****                                                         *****</span>
<a name="ln-869"></a><span class="c">!******************************************************************</span>
<a name="ln-870"></a><span class="c">!   FOURIER TRANSFORMS IN X AND Y DIRECTION   GIVE:</span>
<a name="ln-871"></a><span class="c">!   a^2 P + b^2 P + P_zz =  F(x,y,z) = FFT_i [ FTT_j (f(x,y,z))]</span>
<a name="ln-872"></a>
<a name="ln-873"></a><span class="c">!   where a and b are the KNOWN eigenvalues, and P_zz is</span>
<a name="ln-874"></a>
<a name="ln-875"></a><span class="c">!   P_zz =[ P_{i,j,k+1} - 2 P_{i,j,k} +P_{i,j,k-1} ] / (dz * dz)</span>
<a name="ln-876"></a>
<a name="ln-877"></a><span class="c">!   a^2 P + b^2 +P_zz =</span>
<a name="ln-878"></a><span class="c">!   [P_{i,j,k+1}-(2+a^2+ b^2) P_{i,j,k}+P_{i,j,k-1}]/(dz*dz)=F( x,y,z)</span>
<a name="ln-879"></a>
<a name="ln-880"></a><span class="c">!   The equation above results in a tridiagonal system in k which</span>
<a name="ln-881"></a><span class="c">!   can be solved with Gaussian elemination --&gt; P</span>
<a name="ln-882"></a><span class="c">!   The P we have found with the Gaussian elemination is still in</span>
<a name="ln-883"></a><span class="c">!   the Fourier Space and 2 backward FFTS are necessary to compute</span>
<a name="ln-884"></a><span class="c">!   the physical P</span>
<a name="ln-885"></a><span class="c">!******************************************************************</span>
<a name="ln-886"></a><span class="c">!******************************************************************</span>
<a name="ln-887"></a><span class="c">!******************************************************************</span>
<a name="ln-888"></a><span class="c">!****   Programmer: Bendiks Jan Boersma                      ******</span>
<a name="ln-889"></a><span class="c">!****               email : b.j.boersma@wbmt.tudelft.nl      ******</span>
<a name="ln-890"></a><span class="c">!****                                                        ******</span>
<a name="ln-891"></a><span class="c">!****   USES      :  VFFTPACK   (netlib)                     ******</span>
<a name="ln-892"></a><span class="c">!****             :  FFTPACK    (netlib)                     ******</span>
<a name="ln-893"></a><span class="c">!****                (B.J. Boersma &amp; L.J.P. Timmermans)      ******</span>
<a name="ln-894"></a><span class="c">!****                                                        ******</span>
<a name="ln-895"></a><span class="c">!******************************************************************</span>
<a name="ln-896"></a><span class="c">!******************************************************************</span>
<a name="ln-897"></a>
<a name="ln-898"></a><span class="c">! mpi-version, no master region for timing</span>
<a name="ln-899"></a><span class="c">!              copy times all included</span>
<a name="ln-900"></a>   <span class="k">use </span><span class="n">modmpi</span><span class="p">,</span>    <span class="k">only</span> <span class="p">:</span> <span class="n">myid</span><span class="p">,</span><span class="n">comm3d</span><span class="p">,</span><span class="n">mpierr</span><span class="p">,</span><span class="n">nprocs</span><span class="p">,</span> <span class="n">barrou</span>
<a name="ln-901"></a>    <span class="k">use </span><span class="n">modglobal</span><span class="p">,</span> <span class="k">only</span> <span class="p">:</span> <span class="n">imax</span><span class="p">,</span><span class="n">jmax</span><span class="p">,</span><span class="n">kmax</span><span class="p">,</span><span class="n">isen</span><span class="p">,</span><span class="n">jtot</span><span class="p">,</span><span class="n">pi</span><span class="p">,</span><span class="n">dyi</span><span class="p">,</span><span class="n">dzf</span><span class="p">,</span><span class="n">dzh</span><span class="p">,</span> <span class="n">dxfi</span><span class="p">,</span> <span class="n">kb</span><span class="p">,</span> <span class="n">ke</span><span class="p">,</span> <span class="n">kh</span>
<a name="ln-902"></a><span class="c">!, rhoa</span>
<a name="ln-903"></a><span class="c">!    use modfields, only : rhobf, rhobh</span>
<a name="ln-904"></a>    <span class="k">implicit none</span>
<a name="ln-905"></a><span class="k">    </span><span class="kt">real</span> <span class="kd">::</span> <span class="n">dxi</span>
<a name="ln-906"></a>    <span class="kt">integer</span> <span class="kd">::</span> <span class="n">i1</span><span class="p">,</span> <span class="n">j1</span><span class="p">,</span> <span class="n">k1</span>
<a name="ln-907"></a><span class="c">!   real, intent(inout), dimension(:,:,:) :: p1 </span>
<a name="ln-908"></a>    <span class="kt">real </span><span class="n">p1</span><span class="p">(</span><span class="mi">0</span><span class="p">:</span><span class="n">imax</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="n">jmax</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="n">kmax</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-909"></a>
<a name="ln-910"></a>    <span class="kt">real</span><span class="p">,</span> <span class="k">allocatable</span><span class="p">,</span> <span class="k">dimension</span><span class="p">(:,:,:)</span> <span class="kd">::</span> <span class="n">d</span><span class="p">,</span><span class="n">p2</span>
<a name="ln-911"></a>    <span class="kt">real</span><span class="p">,</span> <span class="k">allocatable</span><span class="p">,</span> <span class="k">dimension</span><span class="p">(:,:,:)</span> <span class="kd">::</span> <span class="n">xyzrt</span>
<a name="ln-912"></a>    <span class="kt">real</span><span class="p">,</span> <span class="k">allocatable</span><span class="p">,</span> <span class="k">dimension</span><span class="p">(:)</span> <span class="kd">::</span> <span class="n">xrt</span><span class="p">,</span><span class="n">yrt</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">FFTI</span><span class="p">,</span><span class="n">FFTJ</span><span class="p">,</span><span class="n">winew</span><span class="p">,</span><span class="n">wjnew</span><span class="p">,</span> <span class="n">rhobf</span><span class="p">,</span> <span class="n">rhobh</span>
<a name="ln-913"></a>    <span class="kt">real    </span><span class="n">z</span><span class="p">,</span><span class="n">ak</span><span class="p">,</span><span class="n">bk</span><span class="p">,</span><span class="n">bbk</span><span class="p">,</span><span class="n">fac</span>
<a name="ln-914"></a>    <span class="kt">integer </span><span class="n">jv</span>
<a name="ln-915"></a>    <span class="kt">integer </span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span>
<a name="ln-916"></a>    <span class="c">!real dzl(ke+kh-(kb-kh)),dzhl(ke+kh-(kb-kh))</span>
<a name="ln-917"></a>    <span class="kt">real </span><span class="n">dzl</span><span class="p">(</span><span class="mi">0</span><span class="p">:</span><span class="n">kmax</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span><span class="n">dzhl</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">kmax</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-918"></a>
<a name="ln-919"></a>    <span class="n">dxi</span> <span class="o">=</span> <span class="n">dxfi</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-920"></a>    <span class="n">dzl</span><span class="p">(</span><span class="mi">0</span><span class="p">:</span><span class="n">kmax</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">dzf</span><span class="p">(</span><span class="n">kb</span><span class="o">-</span><span class="n">kh</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">)</span>
<a name="ln-921"></a>    <span class="n">dzhl</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">kmax</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">dzh</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">)</span>
<a name="ln-922"></a>
<a name="ln-923"></a>    <span class="n">i1</span> <span class="o">=</span> <span class="n">imax</span><span class="o">+</span><span class="mi">1</span>
<a name="ln-924"></a>    <span class="n">j1</span> <span class="o">=</span> <span class="n">jmax</span><span class="o">+</span><span class="mi">1</span>
<a name="ln-925"></a>    <span class="n">k1</span> <span class="o">=</span> <span class="n">kmax</span><span class="o">+</span><span class="mi">1</span>
<a name="ln-926"></a> <span class="c">!   allocate(p1(0:i1,0:j1,0:k1))</span>
<a name="ln-927"></a>  <span class="c">! p and d distributed equally:</span>
<a name="ln-928"></a>    <span class="k">allocate</span><span class="p">(</span><span class="n">d</span><span class="p">(</span><span class="n">imax</span><span class="p">,</span><span class="n">jmax</span><span class="p">,</span><span class="n">kmax</span><span class="p">))</span>
<a name="ln-929"></a>
<a name="ln-930"></a>  <span class="c">! re-distributed p:</span>
<a name="ln-931"></a>
<a name="ln-932"></a>    <span class="k">allocate</span><span class="p">(</span><span class="n">p2</span><span class="p">(</span><span class="n">isen</span><span class="p">,</span><span class="n">jtot</span><span class="p">,</span><span class="n">kmax</span><span class="p">))</span>
<a name="ln-933"></a>
<a name="ln-934"></a>  <span class="c">! re-distributed p1:</span>
<a name="ln-935"></a>
<a name="ln-936"></a>    <span class="k">allocate</span><span class="p">(</span><span class="n">rhobf</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">kmax</span><span class="p">),</span> <span class="n">rhobh</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">kmax</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
<a name="ln-937"></a>    <span class="k">allocate</span><span class="p">(</span><span class="n">xyzrt</span><span class="p">(</span><span class="mi">0</span><span class="p">:</span><span class="n">i1</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="n">j1</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="n">k1</span><span class="p">),</span><span class="n">xrt</span><span class="p">(</span><span class="mi">0</span><span class="p">:</span><span class="n">i1</span><span class="p">),</span><span class="n">yrt</span><span class="p">(</span><span class="mi">0</span><span class="p">:</span><span class="n">jtot</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
<a name="ln-938"></a>    <span class="k">allocate</span><span class="p">(</span><span class="n">a</span><span class="p">(</span><span class="mi">0</span><span class="p">:</span><span class="n">kmax</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span><span class="n">b</span><span class="p">(</span><span class="mi">0</span><span class="p">:</span><span class="n">kmax</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span><span class="n">c</span><span class="p">(</span><span class="mi">0</span><span class="p">:</span><span class="n">kmax</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
<a name="ln-939"></a>    <span class="k">allocate</span><span class="p">(</span><span class="n">FFTI</span><span class="p">(</span><span class="n">imax</span><span class="p">),</span><span class="n">FFTJ</span><span class="p">(</span><span class="n">jtot</span><span class="p">),</span><span class="n">winew</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">imax</span><span class="o">+</span><span class="mi">15</span><span class="p">),</span><span class="n">wjnew</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">jtot</span><span class="o">+</span><span class="mi">15</span><span class="p">))</span>
<a name="ln-940"></a>
<a name="ln-941"></a>    <span class="n">rhobf</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span> <span class="n">rhobh</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a name="ln-942"></a>
<a name="ln-943"></a>    <span class="k">call </span><span class="n">MPI_COMM_RANK</span><span class="p">(</span> <span class="n">comm3d</span><span class="p">,</span> <span class="n">myid</span><span class="p">,</span> <span class="n">mpierr</span> <span class="p">)</span>
<a name="ln-944"></a>    <span class="k">call </span><span class="n">MPI_COMM_SIZE</span><span class="p">(</span> <span class="n">comm3d</span><span class="p">,</span> <span class="n">nprocs</span><span class="p">,</span> <span class="n">mpierr</span> <span class="p">)</span>
<a name="ln-945"></a>    <span class="k">call </span><span class="n">rffti</span><span class="p">(</span><span class="n">imax</span><span class="p">,</span><span class="n">winew</span><span class="p">)</span>
<a name="ln-946"></a>    <span class="k">call </span><span class="n">rffti</span><span class="p">(</span><span class="n">jtot</span><span class="p">,</span><span class="n">wjnew</span><span class="p">)</span>
<a name="ln-947"></a><span class="c">!     call barrou()</span>
<a name="ln-948"></a>  <span class="c">!FFT  ---&gt; I direction</span>
<a name="ln-949"></a>    <span class="n">fac</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="nb">sqrt</span><span class="p">(</span><span class="n">imax</span><span class="o">*</span><span class="mf">1.</span><span class="p">)</span>
<a name="ln-950"></a>    <span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">kmax</span>
<a name="ln-951"></a>      <span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">jmax</span>
<a name="ln-952"></a>          <span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">imax</span>
<a name="ln-953"></a>            <span class="n">FFTI</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span><span class="n">p1</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>
<a name="ln-954"></a>          <span class="k">end do</span>
<a name="ln-955"></a><span class="k">          call </span><span class="n">rfftf</span><span class="p">(</span><span class="n">imax</span><span class="p">,</span><span class="n">FFTI</span><span class="p">,</span><span class="n">winew</span><span class="p">)</span>
<a name="ln-956"></a>          <span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">imax</span>
<a name="ln-957"></a>  <span class="c">! ATT: First back to p1, then re-distribution!!!</span>
<a name="ln-958"></a>            <span class="n">p1</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">=</span><span class="n">FFTI</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="n">fac</span>
<a name="ln-959"></a>          <span class="k">end do</span>
<a name="ln-960"></a><span class="k">      end do</span>
<a name="ln-961"></a><span class="k">    end do</span>
<a name="ln-962"></a><span class="k">    call </span><span class="n">ALL_ALL_j</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span><span class="n">p2</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
<a name="ln-963"></a>  <span class="c">!FFT  ---&gt; J direction</span>
<a name="ln-964"></a>    <span class="n">fac</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="nb">sqrt</span><span class="p">(</span><span class="n">jtot</span><span class="o">*</span><span class="mf">1.</span><span class="p">)</span>
<a name="ln-965"></a>    <span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">isen</span>
<a name="ln-966"></a>      <span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">kmax</span>
<a name="ln-967"></a>          <span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">jtot</span>
<a name="ln-968"></a>            <span class="n">FFTJ</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="o">=</span><span class="n">p2</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>
<a name="ln-969"></a>          <span class="k">end do</span>
<a name="ln-970"></a><span class="k">          call </span><span class="n">rfftf</span><span class="p">(</span><span class="n">jtot</span><span class="p">,</span><span class="n">FFTJ</span><span class="p">,</span><span class="n">wjnew</span><span class="p">)</span>
<a name="ln-971"></a>          <span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">jtot</span>
<a name="ln-972"></a>  <span class="c">! ATTT back to pl</span>
<a name="ln-973"></a>            <span class="n">p2</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">=</span><span class="n">FFTJ</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">*</span><span class="n">fac</span>
<a name="ln-974"></a>          <span class="k">end do</span>
<a name="ln-975"></a><span class="k">      end do</span>
<a name="ln-976"></a><span class="k">    end do</span>
<a name="ln-977"></a><span class="c">!     call barrou()</span>
<a name="ln-978"></a>    <span class="k">call </span><span class="n">ALL_ALL_j</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span><span class="n">p2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-979"></a><span class="c">!     call barrou()</span>
<a name="ln-980"></a>
<a name="ln-981"></a>
<a name="ln-982"></a>  <span class="c">! Generate Eigenvalues  (xrt and yrt )</span>
<a name="ln-983"></a>
<a name="ln-984"></a>  <span class="c">!  I --&gt; direction</span>
<a name="ln-985"></a>
<a name="ln-986"></a>
<a name="ln-987"></a>    <span class="n">fac</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">imax</span><span class="p">)</span>
<a name="ln-988"></a>    <span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">imax</span><span class="p">,</span><span class="mi">2</span>
<a name="ln-989"></a>      <span class="n">xrt</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">=-</span><span class="mf">4.</span><span class="o">*</span><span class="n">dxi</span><span class="o">*</span><span class="n">dxi</span><span class="o">*</span><span class="p">(</span><span class="nb">sin</span><span class="p">(</span><span class="nb">float</span><span class="p">((</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="n">fac</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span>
<a name="ln-990"></a>      <span class="n">xrt</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>  <span class="o">=</span> <span class="n">xrt</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-991"></a>    <span class="k">end do</span>
<a name="ln-992"></a><span class="k">    </span><span class="n">xrt</span><span class="p">(</span><span class="mi">1</span>    <span class="p">)</span> <span class="o">=</span> <span class="mf">0.</span>
<a name="ln-993"></a>    <span class="n">xrt</span><span class="p">(</span><span class="n">imax</span> <span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="mf">4.</span><span class="o">*</span><span class="n">dxi</span><span class="o">*</span><span class="n">dxi</span>
<a name="ln-994"></a>
<a name="ln-995"></a>  <span class="c">!  J --&gt; direction</span>
<a name="ln-996"></a>
<a name="ln-997"></a>    <span class="n">fac</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">jtot</span><span class="p">)</span>
<a name="ln-998"></a>    <span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">jtot</span><span class="p">,</span><span class="mi">2</span>
<a name="ln-999"></a>      <span class="n">yrt</span><span class="p">(</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">=-</span><span class="mf">4.</span><span class="o">*</span><span class="n">dyi</span><span class="o">*</span><span class="n">dyi</span><span class="o">*</span><span class="p">(</span><span class="nb">sin</span><span class="p">(</span><span class="nb">float</span><span class="p">((</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="n">fac</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span>
<a name="ln-1000"></a>      <span class="n">yrt</span><span class="p">(</span><span class="n">j</span>  <span class="p">)</span><span class="o">=</span> <span class="n">yrt</span><span class="p">(</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-1001"></a>    <span class="k">end do</span>
<a name="ln-1002"></a><span class="k">    </span><span class="n">yrt</span><span class="p">(</span><span class="mi">1</span>    <span class="p">)</span> <span class="o">=</span> <span class="mf">0.</span>
<a name="ln-1003"></a>    <span class="n">yrt</span><span class="p">(</span><span class="n">jtot</span> <span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="mf">4.</span><span class="o">*</span><span class="n">dyi</span><span class="o">*</span><span class="n">dyi</span>
<a name="ln-1004"></a>
<a name="ln-1005"></a>  <span class="c">! Generate tridiagonal matrix</span>
<a name="ln-1006"></a>
<a name="ln-1007"></a>    <span class="c">! NOTE -- dzfm dzh are defined from 0 -- hence ..-1</span>
<a name="ln-1008"></a>    <span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">kmax</span>
<a name="ln-1009"></a>      <span class="c">! SB fixed the coefficients</span>
<a name="ln-1010"></a>      <span class="n">a</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">=</span><span class="n">rhobh</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">dzl</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">dzhl</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
<a name="ln-1011"></a>      <span class="n">c</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">=</span><span class="n">rhobh</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">dzl</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">dzhl</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
<a name="ln-1012"></a>      <span class="n">b</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">=-</span><span class="p">(</span><span class="n">a</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">+</span><span class="n">c</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
<a name="ln-1013"></a>    <span class="k">end do</span>
<a name="ln-1014"></a><span class="k">   </span><span class="n">b</span><span class="p">(</span><span class="mi">1</span>   <span class="p">)</span><span class="o">=</span><span class="n">b</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="n">a</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-1015"></a>    <span class="n">a</span><span class="p">(</span><span class="mi">1</span>   <span class="p">)</span><span class="o">=</span><span class="mf">0.</span>
<a name="ln-1016"></a>    <span class="n">b</span><span class="p">(</span><span class="n">kmax</span><span class="p">)</span><span class="o">=</span><span class="n">b</span><span class="p">(</span><span class="n">kmax</span><span class="p">)</span><span class="o">+</span><span class="n">c</span><span class="p">(</span><span class="n">kmax</span><span class="p">)</span>
<a name="ln-1017"></a>    <span class="n">c</span><span class="p">(</span><span class="n">kmax</span><span class="p">)</span><span class="o">=</span><span class="mf">0.</span>
<a name="ln-1018"></a>
<a name="ln-1019"></a>    <span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">kmax</span>
<a name="ln-1020"></a>    <span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">jmax</span>
<a name="ln-1021"></a>    <span class="n">jv</span> <span class="o">=</span> <span class="n">j</span> <span class="o">+</span> <span class="n">myid</span><span class="o">*</span><span class="n">jmax</span>
<a name="ln-1022"></a>    <span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">imax</span>
<a name="ln-1023"></a>      <span class="n">xyzrt</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">=</span> <span class="n">rhobf</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">xrt</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">+</span><span class="n">yrt</span><span class="p">(</span><span class="n">jv</span><span class="p">))</span> <span class="c">!!! LH</span>
<a name="ln-1024"></a>    <span class="k">end do</span>
<a name="ln-1025"></a><span class="k">    end do</span>
<a name="ln-1026"></a><span class="k">    end do</span>
<a name="ln-1027"></a>
<a name="ln-1028"></a>  <span class="c">! SOLVE TRIDIAGONAL SYSTEMS WITH GAUSSIAN ELEMINATION</span>
<a name="ln-1029"></a>    <span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">jmax</span>
<a name="ln-1030"></a>      <span class="n">jv</span> <span class="o">=</span> <span class="n">j</span> <span class="o">+</span> <span class="n">myid</span><span class="o">*</span><span class="n">jmax</span>
<a name="ln-1031"></a>      <span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">imax</span>
<a name="ln-1032"></a>        <span class="n">z</span>        <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="p">(</span><span class="n">b</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="n">xyzrt</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
<a name="ln-1033"></a>        <span class="n">d</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">c</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">z</span>
<a name="ln-1034"></a>        <span class="n">p1</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">p1</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">z</span>
<a name="ln-1035"></a>      <span class="k">end do</span>
<a name="ln-1036"></a><span class="k">    end do</span>
<a name="ln-1037"></a>
<a name="ln-1038"></a><span class="k">    do </span><span class="n">k</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">kmax</span><span class="o">-</span><span class="mi">1</span>
<a name="ln-1039"></a>      <span class="k">do  </span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">jmax</span>
<a name="ln-1040"></a>      <span class="n">jv</span> <span class="o">=</span> <span class="n">j</span> <span class="o">+</span> <span class="n">myid</span><span class="o">*</span><span class="n">jmax</span>
<a name="ln-1041"></a>        <span class="k">do  </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">imax</span>
<a name="ln-1042"></a>          <span class="n">bbk</span>      <span class="o">=</span> <span class="n">b</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">+</span><span class="n">xyzrt</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>
<a name="ln-1043"></a>          <span class="n">z</span>        <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="p">(</span><span class="n">bbk</span><span class="o">-</span><span class="n">a</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">d</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
<a name="ln-1044"></a>          <span class="n">d</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">c</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">z</span>
<a name="ln-1045"></a>          <span class="n">p1</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">p1</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="n">a</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">p1</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">*</span><span class="n">z</span>
<a name="ln-1046"></a>        <span class="k">end do</span>
<a name="ln-1047"></a><span class="k">      end do</span>
<a name="ln-1048"></a><span class="k">    end do</span>
<a name="ln-1049"></a>
<a name="ln-1050"></a>
<a name="ln-1051"></a>
<a name="ln-1052"></a><span class="k">    </span><span class="n">ak</span> <span class="o">=</span><span class="n">a</span><span class="p">(</span><span class="n">kmax</span><span class="p">)</span>
<a name="ln-1053"></a>    <span class="n">bk</span> <span class="o">=</span><span class="n">b</span><span class="p">(</span><span class="n">kmax</span><span class="p">)</span>
<a name="ln-1054"></a>    <span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">jmax</span>
<a name="ln-1055"></a>      <span class="n">jv</span> <span class="o">=</span> <span class="n">j</span> <span class="o">+</span> <span class="n">myid</span><span class="o">*</span><span class="n">jmax</span>
<a name="ln-1056"></a>      <span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">imax</span>
<a name="ln-1057"></a>        <span class="n">bbk</span> <span class="o">=</span> <span class="n">bk</span> <span class="o">+</span><span class="n">xyzrt</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">kmax</span><span class="p">)</span>
<a name="ln-1058"></a>        <span class="n">z</span>        <span class="o">=</span> <span class="n">bbk</span><span class="o">-</span><span class="n">ak</span><span class="o">*</span><span class="n">d</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">kmax</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-1059"></a>        <span class="k">if</span><span class="p">(</span><span class="n">z</span><span class="o">/=</span><span class="mf">0.</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1060"></a><span class="k">          </span><span class="n">p1</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">kmax</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">p1</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">kmax</span><span class="p">)</span><span class="o">-</span><span class="n">ak</span><span class="o">*</span><span class="n">p1</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">kmax</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">/</span><span class="n">z</span>
<a name="ln-1061"></a>        <span class="k">else</span>
<a name="ln-1062"></a><span class="k">          </span><span class="n">p1</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">kmax</span><span class="p">)</span> <span class="o">=</span><span class="mf">0.</span>
<a name="ln-1063"></a>        <span class="k">end if</span>
<a name="ln-1064"></a><span class="k">      end do</span>
<a name="ln-1065"></a><span class="k">    end do</span>
<a name="ln-1066"></a><span class="k">   do </span><span class="n">k</span><span class="o">=</span><span class="n">kmax</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span>
<a name="ln-1067"></a>      <span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">jmax</span>
<a name="ln-1068"></a>        <span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">imax</span>
<a name="ln-1069"></a>          <span class="n">p1</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">p1</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="n">d</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">p1</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-1070"></a>        <span class="k">end do</span>
<a name="ln-1071"></a><span class="k">      end do</span>
<a name="ln-1072"></a><span class="k">    end do</span>
<a name="ln-1073"></a><span class="c">!     call barrou()</span>
<a name="ln-1074"></a>
<a name="ln-1075"></a>
<a name="ln-1076"></a>  <span class="c">! MPI_ALL CALL!!!</span>
<a name="ln-1077"></a>
<a name="ln-1078"></a>
<a name="ln-1079"></a>
<a name="ln-1080"></a>    <span class="k">call </span><span class="n">ALL_ALL_j</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span><span class="n">p2</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
<a name="ln-1081"></a><span class="c">!     call barrou()</span>
<a name="ln-1082"></a>
<a name="ln-1083"></a>
<a name="ln-1084"></a>  <span class="c">! BACKWARD FFT ---&gt; I direction</span>
<a name="ln-1085"></a>
<a name="ln-1086"></a>
<a name="ln-1087"></a>  <span class="c">! BACKWARD FFT ---&gt; J direction</span>
<a name="ln-1088"></a>
<a name="ln-1089"></a>    <span class="n">fac</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="nb">sqrt</span><span class="p">(</span><span class="n">jtot</span><span class="o">*</span><span class="mf">1.</span><span class="p">)</span>
<a name="ln-1090"></a>    <span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">isen</span>
<a name="ln-1091"></a>      <span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">kmax</span>
<a name="ln-1092"></a>        <span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">jtot</span>
<a name="ln-1093"></a>  <span class="c">! ATT, ADAPTED!!!</span>
<a name="ln-1094"></a>          <span class="n">FFTJ</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="o">=</span><span class="n">p2</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>
<a name="ln-1095"></a>        <span class="k">end do</span>
<a name="ln-1096"></a><span class="k">        call </span><span class="n">rfftb</span><span class="p">(</span><span class="n">jtot</span><span class="p">,</span><span class="n">FFTJ</span><span class="p">,</span><span class="n">wjnew</span><span class="p">)</span>
<a name="ln-1097"></a>        <span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">jtot</span>
<a name="ln-1098"></a>  <span class="c">! ATT back to p2!!!</span>
<a name="ln-1099"></a>          <span class="n">p2</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">=</span><span class="n">FFTJ</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">*</span><span class="n">fac</span>
<a name="ln-1100"></a>        <span class="k">end do</span>
<a name="ln-1101"></a><span class="k">      end do</span>
<a name="ln-1102"></a><span class="k">    end do</span>
<a name="ln-1103"></a><span class="c">!     call barrou()</span>
<a name="ln-1104"></a>    <span class="k">call </span><span class="n">ALL_ALL_j</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span><span class="n">p2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-1105"></a>
<a name="ln-1106"></a>    <span class="n">fac</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="nb">sqrt</span><span class="p">(</span><span class="n">imax</span><span class="o">*</span><span class="mf">1.</span><span class="p">)</span>
<a name="ln-1107"></a>    <span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">kmax</span>
<a name="ln-1108"></a>      <span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">jmax</span>
<a name="ln-1109"></a>        <span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">imax</span>
<a name="ln-1110"></a>          <span class="n">FFTI</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span><span class="n">p1</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>
<a name="ln-1111"></a>        <span class="k">end do</span>
<a name="ln-1112"></a><span class="k">        call </span><span class="n">rfftb</span><span class="p">(</span><span class="n">imax</span><span class="p">,</span><span class="n">FFTI</span><span class="p">,</span><span class="n">winew</span><span class="p">)</span>
<a name="ln-1113"></a>        <span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">imax</span>
<a name="ln-1114"></a>  <span class="c">! ATT back to p1 !!!</span>
<a name="ln-1115"></a>          <span class="n">p1</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">=</span><span class="n">FFTI</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="n">fac</span>
<a name="ln-1116"></a>        <span class="k">end do</span>
<a name="ln-1117"></a><span class="k">      end do</span>
<a name="ln-1118"></a><span class="k">    end do</span>
<a name="ln-1119"></a><span class="k">   deallocate</span><span class="p">(</span><span class="n">d</span><span class="p">,</span><span class="n">p2</span><span class="p">,</span><span class="n">xyzrt</span><span class="p">,</span><span class="n">xrt</span><span class="p">,</span><span class="n">yrt</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">FFTI</span><span class="p">,</span><span class="n">FFTJ</span><span class="p">,</span><span class="n">winew</span><span class="p">,</span><span class="n">wjnew</span><span class="p">)</span>
<a name="ln-1120"></a><span class="c">!     call barrou()</span>
<a name="ln-1121"></a>    <span class="k">return</span>
<a name="ln-1122"></a><span class="k">  end subroutine </span><span class="n">solmpj</span>
<a name="ln-1123"></a>
<a name="ln-1124"></a>
<a name="ln-1125"></a><span class="k">end module </span><span class="n">modpois</span>
</pre></div>

    </section>
    </div>
  </div>

  
    <hr>    
    </div> <!-- /container -->
    <footer>
      <div class="container">
      <div class="row">
        <div class="col-xs-6 col-md-4"><p>&copy; 2021 
                                          </p></div>
        <div class="col-xs-6 col-md-4 col-md-push-4">
          <p class="text-right">
            Documentation generated by 
            <a href="https://github.com/cmacmackin/ford">FORD</a>
            
          </p>
        </div>
        <div class="col-xs-12 col-md-4 col-md-pull-4"><p class="text-center"> uDALES was developed by The uDALES Team</p></div>
      </div>
      <br>
      </div> <!-- /container -->    
    </footer>

    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
<!--
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
-->
    <script src="../js/bootstrap.min.js"></script>
    <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
    <script src="../js/ie10-viewport-bug-workaround.js"></script>

    <!-- MathJax JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        TeX: { extensions: ['AMSmath.js','AMSsymbols.js','noErrors.js','noUndefined.js'], equationNumbers: { autoNumber: 'AMS' } },
        jax: ['input/TeX','input/MathML','output/HTML-CSS'],
        extensions: ['tex2jax.js','mml2jax.js','MathMenu.js','MathZoom.js']
      });
    </script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    
    <script src="../tipuesearch/tipuesearch_content.js"></script>
    <script src="../tipuesearch/tipuesearch_set.js"></script>
    <script src="../tipuesearch/tipuesearch.js"></script>
    
    
  </body>
</html>